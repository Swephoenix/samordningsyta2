<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <!-- F√∂ljande meta-tagg √§r avg√∂rande f√∂r en "app-k√§nsla" p√• mobilen -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Minimal Dashboard</title>
    <style>
        :root {
            --bg-color: #121a24;
            --panel-bg: rgba(20, 28, 39, 0.82);
            --text-main: #eaf0f8;
            --text-muted: #9fb0c3;
            --border-color: #2b3a4d;
            --accent: #4A90E2;
            --accent-hover: #357ABD;
            --danger: #e74c3c;
            --radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* L√•ser huvudf√∂nstret fr√•n att scrolla */
        body {
            background-color: var(--bg-color);
            background-image:
                radial-gradient(
                    circle at center,
                    #2c3b50 0%,
                    #1f2b3a 45%,
                    #121a24 100%
                );
            color: var(--text-main);
            height: 100vh;
            overflow: hidden; 
            display: flex;
            padding: 20px;
            gap: 20px;
            position: relative;
        }
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            pointer-events: none;
            background:
                linear-gradient(
                    180deg,
                    rgba(255,255,255,0.03),
                    rgba(0,0,0,0.15)
                );
            z-index: 0;
        }
        .auth-logout {
            border: 1px solid var(--border-color);
            background: rgba(255,255,255,0.06);
            color: #dfe9f7;
            border-radius: 10px;
            padding: 12px 14px;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 700;
            width: 100%;
            min-height: 44px;
        }
        .auth-logout:hover { background: rgba(255,255,255,0.12); }
        .meetings-logout-wrap {
            margin-top: 6px;
            display: flex;
            justify-content: stretch;
            padding-top: 4px;
            border-top: 1px solid #dde6f6;
            margin-top: auto;
        }

        /* Layout Grid */
        .dashboard {
            display: grid;
            grid-template-columns: 300px 1fr 350px;
            gap: 20px;
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 1;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: var(--radius);
            box-shadow: 0 16px 32px rgba(0,0,0,0.24);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(6px);
        }

        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            background: rgba(255,255,255,0.03);
            color: #dbe7f5;
        }

        .panel-content {
            padding: 20px;
            overflow-y: auto; /* Intern scroll */
            flex: 1;
        }

        /* V√§nster kolumn */
        .left-col { display: flex; flex-direction: column; gap: 20px; }
        .messages { flex: 1; }
        .meetings { flex: 1.25; min-height: 250px; }
        .notes { flex: 1.2; }
        .left-col .placeholders { flex: 1.35; min-height: 300px; }
        
        textarea.note-area {
            width: 100%;
            height: 100%;
            border: none;
            resize: none;
            outline: none;
            color: var(--text-main);
            background: transparent;
            line-height: 1.5;
        }

        .msg-item {
            padding: 10px;
            background: rgba(255, 203, 107, 0.12);
            border-left: 4px solid #ffc65a;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .meeting-item {
            padding: 8px 10px;
            background: rgba(74, 144, 226, 0.12);
            border-left: 4px solid var(--accent);
            margin-bottom: 8px;
            border-radius: 4px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .meetings .panel-content {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .meetings-list {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 2px;
        }
        .meeting-link {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            text-decoration: none;
            background: rgba(74, 144, 226, 0.18);
            color: #beddff;
            border: 1px solid rgba(74, 144, 226, 0.35);
        }
        .meeting-link:hover {
            background: rgba(74, 144, 226, 0.27);
        }
        .meeting-edit-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
            border-radius: 8px;
            border: 1px solid #c4d5f3;
            background: #e9f1ff;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .meeting-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .meetings-admin-row {
            display: none;
            justify-content: flex-end;
            margin-bottom: 6px;
        }
        .meetings-admin-btn {
            border: 1px solid #c4d5f3;
            background: #e9f1ff;
            color: #1f4f9d;
            border-radius: 8px;
            font-size: 0.82rem;
            font-weight: 700;
            padding: 6px 10px;
            cursor: pointer;
        }

        /* Mittenkolumn: Chatt */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: #1f2329;
            border-color: #2b313a;
        }
        .chat-panel-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid #2b313a;
            background: #242a33;
        }
        .chat-title-wrap {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }
        .chat-title-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #3a77f3;
            color: #fff;
            font-size: 1.05rem;
            font-weight: 700;
            flex-shrink: 0;
        }
        .chat-title-text {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .chat-title-main {
            font-size: 0.95rem;
            color: #f2f5fb;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .chat-auth-badge {
            font-size: 0.72rem;
            color: #b8c6df;
            background: #2f3743;
            border: 1px solid #3b4453;
            border-radius: 999px;
            padding: 5px 9px;
            max-width: 220px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-header-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: #2f3743;
            color: #9fc2ff;
            cursor: pointer;
            font-size: 0.95rem;
        }
        .chat-header-btn:hover { background: #384355; }
        .chat-search-bar {
            padding: 0;
            border: 0;
            background: transparent;
            display: none;
            grid-template-columns: 1fr auto auto auto;
            gap: 8px;
            align-items: center;
        }
        .chat-presence {
            font-size: 0.78rem;
            color: #95a0b3;
            font-weight: 600;
        }
        .chat-notify-badge {
            display: none;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #3a77f3;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 700;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            margin-left: 8px;
        }
        .chat-search-input,
        .chat-date-input {
            border: 1px solid #3a4353;
            border-radius: 8px;
            padding: 8px 10px;
            outline: none;
            background: #222a36;
            color: #d8e2f0;
        }
        .chat-search-input { min-width: 0; }
        .chat-date-input { width: 145px; }
        .chat-search-btn {
            border: 1px solid #3a4353;
            border-radius: 8px;
            background: #222a36;
            padding: 8px 12px;
            cursor: pointer;
            color: #d8e2f0;
        }
        .chat-search-btn:hover { background: #2a3342; }
        .chat-main-shell {
            flex: 1;
            min-height: 0;
            display: grid;
            grid-template-columns: 260px 1fr;
        }
        .chat-main-pane {
            min-width: 0;
            display: flex;
            flex-direction: column;
        }
        .chat-feed {
            flex: 1;
            overflow-y: auto;
            padding: 18px 16px;
            background: #1f2329;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .date-divider {
            text-align: center;
            position: relative;
            margin: 8px 0 10px;
        }
        .date-divider span {
            background: #2a303b;
            color: #98a2b3;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8em;
        }

        .chat-post {
            max-width: 76%;
            border-radius: 18px;
            padding: 10px 12px;
            margin-bottom: 2px;
            line-height: 1.35;
            font-size: 0.92rem;
            position: relative;
        }
        .chat-post.mine {
            align-self: flex-end;
            background: #7b2cff;
            color: #fff;
            border-bottom-right-radius: 5px;
        }
        .chat-post.theirs {
            align-self: flex-start;
            background: #2f3743;
            color: #e9eef7;
            border-bottom-left-radius: 5px;
            margin-right: 30px;
        }
        .chat-post-seen {
            margin-top: 5px;
            font-size: 0.68rem;
            color: #b7c2d8;
            text-align: right;
            opacity: 0.9;
        }
        .chat-post-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.72rem;
            color: #a8b0c1;
            margin-bottom: 5px;
            gap: 12px;
        }
        .chat-post-meta {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .chat-reply-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: none;
            background: rgba(255,255,255,0.12);
            color: #dce6fb;
            cursor: pointer;
            font-size: 0.72rem;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .chat-reply-btn:hover { background: rgba(255,255,255,0.22); }
        .chat-post.theirs .chat-reply-btn { background: rgba(74,163,255,0.18); color: #cfe2ff; }
        .chat-post.theirs .chat-reply-btn:hover { background: rgba(74,163,255,0.28); }
        .chat-post.theirs .chat-reply-btn {
            position: absolute;
            right: -26px;
            top: 50%;
            transform: translateY(-50%);
        }
        .chat-post-header strong {
            font-weight: 700;
            color: inherit;
        }
        
        .chat-input-area {
            padding: 12px 14px;
            border-top: 1px solid #2b313a;
            display: flex;
            align-items: center;
            gap: 10px;
            background: #242a33;
        }
        .chat-reply-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            padding: 8px 12px;
            border-top: 1px solid #303848;
            background: #2a3140;
            color: #dce6fb;
            font-size: 0.78rem;
        }
        .chat-reply-text {
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-reply-cancel {
            border: none;
            background: transparent;
            color: #9fc2ff;
            cursor: pointer;
            font-weight: 700;
        }
        .chat-reply-preview {
            margin-bottom: 6px;
            padding: 6px 8px;
            border-left: 3px solid rgba(255,255,255,0.45);
            background: rgba(255,255,255,0.08);
            border-radius: 6px;
            font-size: 0.72rem;
            line-height: 1.3;
        }
        .chat-post.theirs .chat-reply-preview {
            border-left-color: rgba(120,160,255,0.75);
            background: rgba(58,119,243,0.12);
        }
        .chat-input-area input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid #3a4353;
            border-radius: 20px;
            outline: none;
            background: #1f2329;
            color: #e8edf7;
        }
        .chat-input-area input::placeholder { color: #97a2b5; }
        .chat-input-tools {
            display: inline-flex;
            gap: 4px;
        }
        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: transparent;
            font-size: 1rem;
            cursor: pointer;
            color: #4aa3ff;
        }
        .btn-icon:hover { background: #303848; }
        .chat-send-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: #3a77f3;
            color: #fff;
            font-size: 0.95rem;
            cursor: pointer;
        }
        .chat-send-btn:hover { background: #2d66d9; }
        .chat-input-area .btn-icon[title="Bifoga fil"] {
            width: 34px;
            height: 34px;
            background: #303848;
        }
        .chat-thread-sidebar {
            min-width: 0;
            background: #222831;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2b313a;
        }
        .chat-thread-sidebar-header {
            padding: 12px 12px 10px;
            border-bottom: 1px solid #2b313a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }
        .chat-thread-search-wrap {
            padding: 8px 10px;
            border-bottom: 1px solid #2b313a;
            background: #222831;
        }
        .chat-thread-search {
            width: 100%;
            border: 1px solid #3a4353;
            border-radius: 999px;
            background: #1f2630;
            color: #dce6fb;
            font-size: 0.82rem;
            padding: 8px 12px;
            outline: none;
        }
        .chat-thread-search::placeholder { color: #8f9db5; }
        .chat-thread-sidebar-header span {
            font-size: 0.82rem;
            font-weight: 700;
            color: #dce5f8;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .chat-new-group-btn {
            border: 1px solid #3a4353;
            border-radius: 8px;
            background: #2a3342;
            color: #dbe6ff;
            font-size: 0.74rem;
            font-weight: 700;
            padding: 5px 8px;
            cursor: pointer;
        }
        .chat-new-group-btn:hover { background: #334058; }
        .chat-compose-top {
            display: none;
            position: relative;
            padding: 10px 12px;
            border-bottom: 1px solid #2f3743;
            background: #20262f;
        }
        .chat-compose-row {
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .chat-compose-label {
            color: #c7d4ea;
            font-size: 0.9rem;
            padding-top: 4px;
        }
        .chat-compose-recipients {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }
        .chat-compose-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: #234a7f;
            color: #cde4ff;
            border: 1px solid #2e5f9f;
            border-radius: 8px;
            padding: 4px 8px;
            font-size: 0.78rem;
            font-weight: 700;
        }
        .chat-compose-chip button {
            border: none;
            background: transparent;
            color: #9ec7ff;
            cursor: pointer;
            font-size: 0.82rem;
            line-height: 1;
            padding: 0;
        }
        .chat-compose-input {
            flex: 1 1 180px;
            min-width: 160px;
            border: none;
            background: transparent;
            color: #e7efff;
            font-size: 0.9rem;
            padding: 4px 0;
            outline: none;
        }
        .chat-compose-suggestions {
            position: absolute;
            left: 44px;
            right: 12px;
            top: calc(100% - 2px);
            background: #242d39;
            border: 1px solid #374357;
            border-radius: 8px;
            max-height: 190px;
            overflow-y: auto;
            z-index: 40;
            display: none;
        }
        .chat-compose-suggestion {
            width: 100%;
            border: none;
            background: transparent;
            color: #d7e4fa;
            text-align: left;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 0.84rem;
        }
        .chat-compose-suggestion:hover { background: #2d394d; }
        .chat-compose-hint {
            margin-top: 8px;
            font-size: 0.74rem;
            color: #9fb0c9;
            line-height: 1.35;
        }
        .group-create-content {
            background: #242a33;
            border: 1px solid #364052;
            width: min(92vw, 440px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 16px 34px rgba(0,0,0,0.45);
        }
        .group-create-content .modal-close {
            color: #c6d3ea;
            font-size: 1rem;
        }
        .group-create-content h3 {
            margin-bottom: 10px;
            font-size: 1.05rem;
            color: #eef3fc;
        }
        .group-create-row { margin-bottom: 10px; }
        .group-create-row label {
            display: block;
            font-size: 0.82rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: #c8d5ea;
        }
        .group-create-row input {
            width: 100%;
            border: 1px solid #3c4658;
            border-radius: 8px;
            padding: 8px 10px;
            outline: none;
            background: #1f2530;
            color: #edf3ff;
        }
        .group-create-row input::placeholder {
            color: #90a0bb;
        }
        .group-create-list {
            max-height: 220px;
            overflow-y: auto;
            border: 1px solid #3a4353;
            border-radius: 8px;
            padding: 6px;
            display: flex;
            flex-direction: column;
            gap: 2px;
            background: #1f2530;
        }
        .group-create-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            padding: 6px;
            border-radius: 6px;
            color: #dce6fb;
        }
        .group-create-item:hover { background: #2d3645; }
        .group-create-item input[type="checkbox"] {
            accent-color: #3a77f3;
        }
        .group-create-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
        .group-create-btn {
            border: 1px solid #3b4558;
            border-radius: 8px;
            background: #2b3342;
            color: #dce6fb;
            padding: 7px 10px;
            cursor: pointer;
        }
        .group-create-btn:hover { background: #354155; }
        .group-create-btn.primary {
            background: #3a77f3;
            border-color: #3a77f3;
            color: #fff;
            font-weight: 700;
        }
        .chat-thread-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .chat-thread-row {
            border: none;
            background: transparent;
            color: inherit;
            text-align: left;
            width: 100%;
            cursor: pointer;
            border-radius: 10px;
            padding: 9px 10px;
            display: grid;
            grid-template-columns: 34px 1fr auto;
            gap: 8px;
            align-items: center;
        }
        .chat-thread-row:hover { background: #2d3440; }
        .chat-thread-row.active { background: #2f3d53; }
        .chat-thread-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            overflow: visible;
            background: #3a4353;
            position: relative;
        }
        .chat-thread-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; border-radius: 50%; }
        .chat-thread-status-dot {
            position: absolute;
            right: -1px;
            bottom: -1px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #222831;
            background: #6f7b90;
        }
        .chat-thread-status-dot.online { background: #31a24c; }
        .chat-thread-text strong {
            display: block;
            color: #edf2fc;
            font-size: 0.82rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-thread-text span {
            display: block;
            margin-top: 2px;
            color: #a6b2c8;
            font-size: 0.74rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-thread-meta {
            min-width: 24px;
            display: flex;
            justify-content: flex-end;
        }
        .chat-thread-unread {
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #46a3ff;
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.68rem;
            font-weight: 700;
            padding: 0 5px;
        }
        .chat-thread-empty {
            color: #98a2b3;
            font-size: 0.8rem;
            padding: 10px;
        }

        /* H√∂ger kolumn: Kalender & Verktyg */
        .right-col { display: flex; flex-direction: column; gap: 20px; }
        .calendar-wrapper { flex: 0 0 auto; }
        .placeholders { flex: 1; }
        .right-col .placeholders {
            flex: 0 0 290px;
            min-height: 290px;
        }
        .calendar-wrapper .panel-content { flex: 0 0 auto; padding-bottom: 14px; }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
            margin-top: 10px;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }
        .calendar-nav {
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            font-size: 1.1em;
            line-height: 1;
        }
        .calendar-nav:hover { background: #e9ecef; }
        .calendar-title { font-weight: 600; }
        .cal-day-header { font-size: 0.8em; color: var(--text-muted); font-weight: bold; }
        .cal-day {
            padding: 10px 0;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: background 0.2s;
        }
        .cal-day:hover { background: var(--bg-color); }
        .cal-day.has-event { font-weight: bold; color: var(--accent); }
        .cal-day.has-event::after {
            content: '';
            position: absolute;
            bottom: 4px; left: 50%;
            transform: translateX(-50%);
            width: 6px; height: 6px;
            background: var(--accent);
            border-radius: 50%;
        }

        .placeholder-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 12px;
        }
        .right-col .placeholders .placeholder-grid {
            margin-top: auto;
            padding-bottom: 16px;
        }
        
        .placeholder-icon {
            background: var(--bg-color);
            height: 64px;
            min-height: 64px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            color: var(--text-main);
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            overflow: visible;
        }
        .messenger-tool-icon { position: relative; }
        .tool-unread-badge {
            position: absolute;
            top: -7px;
            right: -7px;
            min-width: 20px;
            height: 20px;
            padding: 0 6px;
            border-radius: 999px;
            background: #0084ff;
            color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            font-weight: 700;
            line-height: 1;
            border: 2px solid #fff;
            pointer-events: none;
        }
        
        .placeholder-icon:hover {
            transform: scale(1.05);
            background: #e9ecef;
        }
        .tool-icon-svg {
            width: 34px;
            height: 34px;
            object-fit: contain;
            display: block;
            max-width: 100%;
            max-height: 100%;
        }
        .folder-modal-content {
            width: min(92vw, 980px);
            height: min(82vh, 620px);
            background: #fff;
            border: 1px solid #999;
            box-shadow: 0 10px 30px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
        }
        .fs-toolbar {
            height: 42px;
            border-bottom: 1px solid #d9d9d9;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            background: #fff;
        }
        .fs-back-btn {
            padding: 5px 10px;
            cursor: pointer;
            border: 1px solid transparent;
            background: #fff;
        }
        .fs-back-btn:hover {
            background: #e5f3ff;
            border-color: #cce8ff;
        }
        .fs-address-bar {
            flex: 1;
            border: 1px solid #d9d9d9;
            padding: 4px 10px;
            font-size: 13px;
            color: #555;
            background: #fff;
        }
        .fs-close-btn {
            border: 1px solid #d9d9d9;
            background: #fff;
            width: 30px;
            height: 30px;
            cursor: pointer;
        }
        .fs-close-btn:hover { background: #f3f3f3; }
        .fs-file-display {
            flex: 1;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            grid-auto-rows: 112px;
            gap: 10px;
            overflow-y: auto;
            align-content: start;
            background: #fff;
        }
        .fs-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            padding: 5px;
            border-radius: 3px;
        }
        .fs-item:hover {
            background: #e5f3ff;
            border-color: #cce8ff;
        }
        .fs-item-icon {
            font-size: 104px;
            margin-bottom: 5px;
        }
        .fs-item-name {
            font-size: 12px;
            word-break: break-word;
            overflow-wrap: anywhere;
            max-width: 108px;
            color: #111;
        }
        .fs-context-menu {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.12);
            padding: 5px 0;
            display: none;
            z-index: 3;
            min-width: 170px;
        }
        .fs-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 13px;
            color: #111;
        }
        .fs-menu-item:hover {
            background: #0078d7;
            color: #fff;
        }
        .fs-menu-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
            background: transparent;
            color: inherit;
        }
        .fs-share-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.35);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        .fs-share-modal {
            width: min(92%, 520px);
            max-height: min(86%, 560px);
            background: #fff;
            border: 1px solid #d4d4d4;
            border-radius: 10px;
            box-shadow: 0 14px 36px rgba(0,0,0,0.25);
            display: flex;
            flex-direction: column;
        }
        .fs-share-header {
            padding: 12px 14px;
            border-bottom: 1px solid #e3e3e3;
            font-weight: 700;
        }
        .fs-share-list {
            padding: 10px 12px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 120px;
        }
        .fs-share-item {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            border: 1px solid #ececec;
            border-radius: 8px;
            padding: 8px 10px;
        }
        .fs-share-name {
            font-size: 0.9rem;
            color: #222;
        }
        .fs-share-email {
            font-size: 0.78rem;
            color: #666;
        }
        .fs-share-perm {
            border: 1px solid #d0d0d0;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.82rem;
            background: #fff;
        }
        .fs-share-empty {
            font-size: 0.88rem;
            color: #666;
            padding: 8px 2px;
        }
        .fs-share-actions {
            padding: 10px 12px;
            border-top: 1px solid #e3e3e3;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .fs-editor-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 4;
        }
        .fs-editor-container {
            background: #fff;
            width: min(92%, 620px);
            height: min(78%, 420px);
            display: flex;
            flex-direction: column;
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid #cfcfcf;
        }
        .fs-editor-header {
            padding: 10px;
            background: #eee;
            border-bottom: 1px solid #ccc;
            font-size: 0.95rem;
            font-weight: 600;
        }
        .fs-text-content {
            flex: 1;
            padding: 10px;
            border: none;
            resize: none;
            font-family: monospace;
            font-size: 14px;
            outline: none;
        }
        .fs-btn-row {
            padding: 10px;
            text-align: right;
            border-top: 1px solid #ccc;
        }
        .fs-btn {
            padding: 5px 15px;
            cursor: pointer;
        }
        .fs-btn[disabled] {
            opacity: 0.55;
            cursor: not-allowed;
        }
        .fs-btn-primary {
            background: #0078d7;
            color: #fff;
            border: none;
        }
        .event-editor-content {
            background: #fff;
            width: min(92vw, 420px);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
            padding: 18px;
        }
        .event-editor-content h3 {
            margin-bottom: 10px;
        }
        .event-editor-row {
            margin-bottom: 10px;
        }
        .event-editor-row label {
            display: block;
            font-size: 0.82rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        .event-editor-row input {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 10px;
        }
        .event-editor-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            margin-top: 12px;
        }
        .event-editor-btn {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: #fff;
            padding: 7px 10px;
            cursor: pointer;
        }
        .event-editor-btn.primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
            font-weight: 700;
        }

        /* Modals & Popups */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none; align-items: center; justify-content: center;
            z-index: 100;
        }
        .modal-content {
            background: var(--panel-bg);
            padding: 30px;
            border-radius: var(--radius);
            width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .modal-close { float: right; cursor: pointer; border: none; background: none; font-size: 1.2em; }
        
        .zoom-btn {
            display: block; width: 100%; padding: 10px; margin-top: 20px;
            background: var(--accent); color: white; text-align: center;
            text-decoration: none; border-radius: var(--radius); font-weight: bold;
        }

        .messenger-popup {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 380px;
            height: 600px;
            max-height: calc(100vh - 120px);
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border: none;
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 110;
        }
        .msgp-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e4e6eb;
            flex-shrink: 0;
        }
        .msgp-title {
            font-size: 1.2rem;
            font-weight: 700;
            letter-spacing: 0;
            color: #050505;
        }
        .msgp-actions {
            display: flex;
            gap: 6px;
        }
        .msgp-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #0084ff;
            cursor: pointer;
            font-size: 1rem;
        }
        .msgp-action-btn:hover { background: #f0f2f5; }
        .msgp-search {
            margin: 8px 16px;
            background: #f0f2f5;
            border-radius: 20px;
            height: 40px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 12px;
            color: #65676b;
            font-weight: 500;
            font-size: 0.95rem;
            flex-shrink: 0;
        }
        .msgp-search input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            color: #050505;
            font-size: 0.95rem;
            font-weight: 500;
        }
        .msgp-list {
            padding: 0 0 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        .msgp-item {
            display: grid;
            grid-template-columns: 48px 1fr auto;
            align-items: center;
            gap: 12px;
            border: none;
            text-align: left;
            width: 100%;
            border-radius: 0;
            background: transparent;
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .msgp-item:hover { background: #f0f2f5; }
        .msgp-item.is-active {
            background: #f0f2f5;
        }
        .msgp-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            overflow: hidden;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .msgp-avatar img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .msgp-text strong {
            display: block;
            font-size: 0.95rem;
            line-height: 1.2;
            color: #050505;
            font-weight: 600;
        }
        .msgp-text span {
            display: block;
            margin-top: 2px;
            font-size: 0.85rem;
            color: #65676b;
            font-weight: 500;
            line-height: 1.3;
        }
        .msgp-item.is-active .msgp-text strong,
        .msgp-item.is-active .msgp-text span {
            color: inherit;
        }
        .msgp-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            min-width: 30px;
        }
        .msgp-time {
            font-size: 0.75rem;
            color: #65676b;
            font-weight: 500;
        }
        .msgp-item.is-active .msgp-time { color: #65676b; }
        .msgp-unread {
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #0084ff;
            color: #fff;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.72rem;
            font-weight: 700;
            padding: 0 6px;
        }
        .msgp-empty {
            color: #65676b;
            padding: 20px;
            font-weight: 500;
            text-align: center;
        }
        .msgp-thread {
            display: none;
            flex-direction: column;
            height: 100%;
        }
        .msgp-thread-top {
            padding: 12px;
            background: #fff;
            border-bottom: 1px solid #e4e6eb;
            display: grid;
            grid-template-columns: 34px 42px 1fr 34px;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 2;
        }
        .msgp-icon-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #0084ff;
            cursor: pointer;
        }
        .msgp-icon-btn:hover { background: #f0f2f5; }
        .msgp-thread-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            overflow: hidden;
            border: none;
        }
        .msgp-thread-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .msgp-thread-user strong {
            display: block;
            font-size: 0.95rem;
            color: #050505;
        }
        .msgp-thread-user span {
            display: block;
            font-size: 0.75rem;
            color: #65676b;
            font-weight: 500;
            margin-top: 2px;
        }
        .msgp-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: #fff;
        }
        .msgp-bubble {
            max-width: 75%;
            border-radius: 18px;
            padding: 10px 14px;
            font-size: 0.95rem;
            line-height: 1.4;
            position: relative;
        }
        .msgp-bubble.them {
            align-self: flex-start;
            background: #e4e6eb;
            color: #050505;
            border-bottom-left-radius: 4px;
        }
        .msgp-bubble.me {
            align-self: flex-end;
            background: #0084ff;
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        .msgp-bubble-time {
            display: block;
            margin-top: 4px;
            font-size: 0.7rem;
            opacity: 0.8;
        }
        .msgp-sender {
            font-size: 0.68rem;
            font-weight: 700;
            margin-bottom: 3px;
            opacity: 0.85;
        }
        .msgp-composer {
            border-top: 1px solid #e4e6eb;
            background: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
        }
        .msgp-composer input {
            flex: 1;
            height: 38px;
            border: none;
            border-radius: 20px;
            padding: 0 14px;
            background: #f0f2f5;
            outline: none;
            font-weight: 500;
            color: #050505;
        }
        .msgp-send {
            border: none;
            background: #0084ff;
            color: #fff;
            font-weight: 600;
            border-radius: 18px;
            height: 34px;
            padding: 0 12px;
            cursor: pointer;
        }
        .msgp-typing {
            color: #65676b;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0 16px 8px;
            display: none;
        }

        /* Responsivitet f√∂r mindre sk√§rmar */
        @media (max-width: 1200px) {
            .dashboard { grid-template-columns: 250px 1fr 250px; }
        }
        @media (max-width: 900px) {
            body { overflow: auto; height: auto; }
            .dashboard { grid-template-columns: 1fr; }
            .panel { height: 400px; } /* Ger paneler en fast h√∂jd p√• mobil */
            .calendar-wrapper { height: auto; }
            .chat-search-bar { grid-template-columns: 1fr 1fr; }
            .chat-date-input { width: 100%; }
            .chat-main-shell { grid-template-columns: 1fr; }
            .chat-thread-sidebar { display: none; }
            .messenger-popup {
                bottom: 0;
                right: 0;
                left: 0;
                width: 100%;
                height: 100%;
                max-height: 100vh;
                border-radius: 0;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        
        <!-- V√§nster: Kalender, M√∂ten & Anteckningar -->
        <div class="left-col">
            <div class="panel calendar-wrapper">
                <div class="panel-header calendar-header">
                    <button class="calendar-nav" id="prevMonthBtn" aria-label="F√∂reg√•ende m√•nad">‚Äπ</button>
                    <span class="calendar-title" id="calendarTitle">Kalender</span>
                    <button class="calendar-nav" id="nextMonthBtn" aria-label="N√§sta m√•nad">‚Ä∫</button>
                </div>
                <div class="panel-content">
                    <div class="meetings-admin-row" id="meetingsAdminRow">
                        <button class="meetings-admin-btn" type="button" onclick="openEventEditorCreate()">+ Nytt m√∂te</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="cal-day-header">M</div><div class="cal-day-header">T</div><div class="cal-day-header">O</div><div class="cal-day-header">T</div><div class="cal-day-header">F</div><div class="cal-day-header">L</div><div class="cal-day-header">S</div>
                    </div>
                </div>
            </div>

            <!-- M√∂tespanelen -->
            <div class="panel meetings">
                <div class="panel-header">Dagens m√∂ten</div>
                <div class="panel-content">
                    <div class="meetings-list" id="meetingsList"></div>
                    <div class="meetings-logout-wrap">
                        <button class="auth-logout" type="button" onclick="logout()">Logga ut</button>
                    </div>
                </div>
            </div>
            <div class="panel notes">
                <div class="panel-header">Mina Anteckningar</div>
                <div class="panel-content">
                    <textarea id="notesArea" class="note-area" placeholder="Skriv dina tankar h√§r... Spara sker automatiskt."></textarea>
                </div>
            </div>
        </div>

        <!-- Mitten: Gruppchatt -->
        <div class="panel chat-container">
            <div class="panel-header chat-panel-title">
                <div class="chat-title-wrap">
                    <div class="chat-title-avatar">TA</div>
                    <div class="chat-title-text">
                        <span class="chat-title-main"></span>
                        <span class="chat-presence" id="groupChatPresence">0 online</span>
                    </div>
                    <span class="chat-notify-badge" id="mainChatUnreadBadge">0</span>
                </div>
                <div class="chat-header-actions">
                    <span class="chat-auth-badge" id="chatCurrentUserBadge">Inloggad som: -</span>
                    <button class="chat-header-btn" type="button" title="Samtal">üìû</button>
                    <button class="chat-header-btn" type="button" title="Video">üé•</button>
                    <button class="chat-header-btn" type="button" title="Info">‚Ñπ</button>
                </div>
            </div>
            <div class="chat-search-bar">
                <input id="chatSearchText" type="text" class="chat-search-input" placeholder="S√∂k i chatten...">
                <input id="chatFromDate" type="date" class="chat-date-input" aria-label="Fr√•n datum">
                <input id="chatToDate" type="date" class="chat-date-input" aria-label="Till datum">
                <button id="chatSearchBtn" class="chat-search-btn" type="button">S√∂k</button>
            </div>
            <div class="chat-main-shell">
                <aside class="chat-thread-sidebar">
                    <div class="chat-thread-sidebar-header">
                        <span>Chattar</span>
                        <button class="chat-new-group-btn" type="button" id="newComposeBtn" title="Ny chatt">‚úé</button>
                    </div>
                    <div class="chat-thread-search-wrap">
                        <input id="mainChatThreadSearch" class="chat-thread-search" type="text" placeholder="S√∂k chattar och anv√§ndare...">
                    </div>
                    <div class="chat-thread-list" id="mainChatThreadList"></div>
                </aside>
                <div class="chat-main-pane">
                    <div class="chat-compose-top" id="chatComposeTop">
                    <div class="chat-compose-row">
                        <span class="chat-compose-label">To:</span>
                        <div class="chat-compose-recipients" id="chatComposeRecipients"></div>
                    </div>
                    <div class="chat-compose-hint" id="chatComposeHint">
                        Tips: skriv ett namn och tryck mellanslag f√∂r att l√§gga till mottagare. Tryck Enter eller bl√• pil nedan f√∂r att skicka.
                    </div>
                    <div class="chat-compose-suggestions" id="chatComposeSuggestions"></div>
                </div>
                    <div class="chat-feed" id="groupChatFeed"></div>
                    <div class="chat-reply-bar" id="chatReplyBar">
                        <span class="chat-reply-text" id="chatReplyText"></span>
                        <button class="chat-reply-cancel" id="chatReplyCancelBtn" type="button">Avbryt</button>
                    </div>
                    <div class="chat-input-area">
                        <button class="btn-icon" title="Bifoga fil">üìé</button>
                        <div class="chat-input-tools">
                            <button class="btn-icon" title="Emoji">üôÇ</button>
                            <button class="btn-icon" title="Bild">üñºÔ∏è</button>
                        </div>
                        <input id="groupChatInput" type="text" placeholder="Skriv ett inl√§gg eller ladda upp fil...">
                        <button id="groupChatSendBtn" class="chat-send-btn" title="Skicka">‚û§</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- H√∂ger: Viktiga meddelanden & Verktyg -->
        <div class="right-col">
            <div class="panel messages">
                <div class="panel-header">Viktiga Meddelanden</div>
                <div class="panel-content">
                    <div class="msg-item">üö® Systemuppdatering inatt kl 02:00.</div>
                    <div class="msg-item">üì¢ Deadline f√∂r Q3-rapporten √§r p√• fredag.</div>
                </div>
            </div>

            <div class="panel placeholders">
                <div class="panel-header">Verktyg</div>
                <div class="placeholder-grid">
                    <div class="placeholder-icon" title="Facebook Marketing Academy">üéì</div>
                    <div class="placeholder-icon" title="Id√©bank">üí°</div>
                    <div class="placeholder-icon" title="Statistik">üìä</div>
                    <div class="placeholder-icon" title="Inst√§llningar">‚öôÔ∏è</div>
                    <div class="placeholder-icon" id="adminSettingsIcon" title="Admin inst√§llning" style="display:none;">üõ°Ô∏è</div>
                    <div class="placeholder-icon" title="Mapp" onclick="openFolderModal()">
                        <img src="folder.svg" alt="Mapp" class="tool-icon-svg">
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Kalender Event Modal -->
    <div class="modal-overlay" id="eventModal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">‚úñ</button>
            <h2 id="modalDate" style="margin-bottom: 10px;">Datum</h2>
            <p><strong>H√§ndelse:</strong> <span id="modalTitle">Titel</span></p>
            <p style="color: var(--text-muted); font-size: 0.9em; margin-top: 10px;">Detta √§r ett online-m√∂te.</p>
            <a href="#" id="modalLink" target="_blank" class="zoom-btn">üé• Anslut till m√∂tet (Zoom)</a>
            <button id="modalEditEventBtn" class="event-editor-btn" style="display:none; margin-top:10px;" type="button">Redigera m√∂te</button>
        </div>
    </div>

    <div class="modal-overlay" id="eventEditorModal">
        <div class="event-editor-content">
            <button class="modal-close" onclick="closeEventEditor()">‚úñ</button>
            <h3 id="eventEditorTitle">Nytt m√∂te</h3>
            <div class="event-editor-row">
                <label for="eventEditorDate">Datum</label>
                <input id="eventEditorDate" type="date">
            </div>
            <div class="event-editor-row">
                <label for="eventEditorText">Titel (inkl. tid, t.ex. 10:00 - Veckom√∂te)</label>
                <input id="eventEditorText" type="text" placeholder="10:00 - Veckom√∂te Team Alpha">
            </div>
            <div class="event-editor-row">
                <label for="eventEditorLink">M√∂tesl√§nk</label>
                <input id="eventEditorLink" type="url" placeholder="https://zoom.us/j/...">
            </div>
            <div class="event-editor-actions">
                <button class="event-editor-btn" type="button" onclick="closeEventEditor()">Avbryt</button>
                <button class="event-editor-btn primary" type="button" id="eventEditorSaveBtn">Spara</button>
            </div>
        </div>
    </div>

        <div class="modal-overlay" id="folderModal">
        <div class="folder-modal-content">
            <div class="fs-toolbar">
                <button class="fs-back-btn" type="button" onclick="fsGoBack()">‚¨Ö Upp</button>
                <div class="fs-address-bar" id="fsAddressBar">Denna dator > Dokument</div>
                <button class="fs-close-btn" type="button" onclick="closeFolderModal()">‚úï</button>
            </div>
            <div class="fs-file-display" id="fsFileDisplay"></div>

            <div class="fs-context-menu" id="fsContextMenu">
                <div class="fs-menu-item" onclick="fsCreateNewItem('folder')">Ny mapp</div>
                <div class="fs-menu-item" onclick="fsCreateNewItem('file')">Ny textfil (.txt)</div>
                <div class="fs-menu-item" id="fsShareItemMenu" onclick="fsOpenShareModalForContextTarget()">Dela...</div>
                <div class="fs-menu-item" id="fsDeleteItemMenu" onclick="fsDeleteContextTarget()">Ta bort markerad</div>
            </div>

            <div class="fs-editor-overlay" id="fsEditorOverlay">
                <div class="fs-editor-container">
                    <div class="fs-editor-header" id="fsEditorFilename">Filnamn.txt</div>
                    <textarea class="fs-text-content" id="fsTextContent"></textarea>
                    <div class="fs-btn-row">
                        <button class="fs-btn" type="button" onclick="fsCloseEditor()">Avbryt</button>
                        <button class="fs-btn fs-btn-primary" id="fsSaveBtn" type="button" onclick="fsSaveFile()">Spara</button>
                    </div>
                </div>
            </div>

            <div class="fs-share-overlay" id="fsShareOverlay">
                <div class="fs-share-modal">
                    <div class="fs-share-header" id="fsShareTitle">Dela</div>
                    <div class="fs-share-list" id="fsShareList"></div>
                    <div class="fs-share-actions">
                        <button class="fs-btn" type="button" onclick="fsCloseShareModal()">Avbryt</button>
                        <button class="fs-btn fs-btn-primary" type="button" onclick="fsApplyShare()">Dela</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="groupCreateModal">
        <div class="group-create-content">
            <button class="modal-close" type="button" onclick="closeGroupCreateModal()">‚úñ</button>
            <h3>Skapa gruppchatt</h3>
            <div class="group-create-row">
                <label for="groupCreateName">Gruppnamn</label>
                <input id="groupCreateName" type="text" placeholder="T.ex. Projekt X">
            </div>
            <div class="group-create-row">
                <label>Bjud in anv√§ndare</label>
                <div class="group-create-list" id="groupCreateUserList"></div>
            </div>
            <div class="group-create-actions">
                <button class="group-create-btn" type="button" onclick="closeGroupCreateModal()">Avbryt</button>
                <button class="group-create-btn primary" type="button" id="groupCreateSaveBtn">Skapa & bjud in</button>
            </div>
        </div>
    </div>

    <script>
        let currentUserEmail = '';
        let currentUserIsAdmin = false;
        let activeModalEvent = null;
        let eventEditorMode = 'create';
        let editingEventId = null;

        async function requireAuth() {
            try {
                const resp = await fetch('/api/me', { credentials: 'include' });
                if (!resp.ok) {
                    const next = encodeURIComponent(window.location.pathname + window.location.search);
                    window.location.href = `login.html?next=${next}`;
                    return false;
                }
                const data = await resp.json();
                currentUserEmail = String(data.email || '');
                currentUserIsAdmin = !!data.is_admin;
                const userBadge = document.getElementById('chatCurrentUserBadge');
                if (userBadge) userBadge.innerText = `Inloggad som: ${currentUserEmail || '-'}`;
                document.getElementById('adminSettingsIcon').style.display = currentUserIsAdmin ? 'flex' : 'none';
                document.getElementById('meetingsAdminRow').style.display = currentUserIsAdmin ? 'flex' : 'none';
                return true;
            } catch (e) {
                window.location.href = 'login.html';
                return false;
            }
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST', credentials: 'include' });
            } finally {
                window.location.href = 'login.html';
            }
        }

        const monthNames = [
            'Januari', 'Februari', 'Mars', 'April', 'Maj', 'Juni',
            'Juli', 'Augusti', 'September', 'Oktober', 'November', 'December'
        ];
        const shortMonthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
        const now = new Date();
        const calendarState = { year: now.getFullYear(), month: now.getMonth() };
        let eventsByDate = {};
        let allChatMessages = [];
        let notesSaveTimer = null;
        const loadInFlight = {
            chatMessages: null,
            chatPresence: null,
            todayMeetings: null,
            messengerUsers: null
        };
        const pollConfig = {
            chatMessages: { foregroundMs: 5000, backgroundMs: 25000, maxMs: 120000 },
            chatPresence: { foregroundMs: 7000, backgroundMs: 30000, maxMs: 120000 },
            todayMeetings: { foregroundMs: 60000, backgroundMs: 180000, maxMs: 300000 },
            messengerUsers: { foregroundMs: 3000, backgroundMs: 12000, maxMs: 90000 }
        };
        const pollState = {
            chatMessages: { timerId: null, running: false, failures: 0 },
            chatPresence: { timerId: null, running: false, failures: 0 },
            todayMeetings: { timerId: null, running: false, failures: 0 },
            messengerUsers: { timerId: null, running: false, failures: 0 }
        };

        function singleFlightLoad(key, task) {
            if (loadInFlight[key]) return loadInFlight[key];
            const promise = (async function() {
                return await task();
            })();
            loadInFlight[key] = promise;
            return promise.finally(function() {
                if (loadInFlight[key] === promise) {
                    loadInFlight[key] = null;
                }
            });
        }

        function getPollDelay(taskName) {
            const cfg = pollConfig[taskName];
            const state = pollState[taskName];
            const base = document.hidden ? cfg.backgroundMs : cfg.foregroundMs;
            const multiplier = Math.min(8, Math.pow(2, state.failures));
            return Math.min(cfg.maxMs, base * multiplier);
        }

        async function runPollTask(taskName, taskFn) {
            const state = pollState[taskName];
            if (state.running) return;
            state.running = true;
            try {
                await taskFn();
                state.failures = 0;
            } catch (err) {
                state.failures = Math.min(state.failures + 1, 8);
            } finally {
                state.running = false;
            }
        }

        function schedulePollTask(taskName, taskFn, immediate) {
            const state = pollState[taskName];
            if (state.timerId) {
                clearTimeout(state.timerId);
            }
            const delay = immediate ? 0 : getPollDelay(taskName);
            state.timerId = setTimeout(async function() {
                await runPollTask(taskName, taskFn);
                schedulePollTask(taskName, taskFn, false);
            }, delay);
        }

        function startAdaptivePolling() {
            schedulePollTask('chatMessages', loadChatMessages, false);
            schedulePollTask('chatPresence', loadChatPresence, false);
            schedulePollTask('todayMeetings', loadTodayMeetings, false);
            schedulePollTask('messengerUsers', loadMessengerUsers, false);
        }

        function refreshPollingSoon() {
            schedulePollTask('chatMessages', loadChatMessages, true);
            schedulePollTask('chatPresence', loadChatPresence, true);
            schedulePollTask('messengerUsers', loadMessengerUsers, true);
        }

        async function apiGet(url) {
            const resp = await fetch(url, { credentials: 'include' });
            const data = await resp.json().catch(function() { return {}; });
            if (!resp.ok) throw new Error(data.error || 'API-fel.');
            return data;
        }

        async function apiSend(url, method, payload) {
            const resp = await fetch(url, {
                method: method,
                credentials: 'include',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload || {})
            });
            const data = await resp.json().catch(function() { return {}; });
            if (!resp.ok) throw new Error(data.error || 'API-fel.');
            return data;
        }

        function formatDateKey(year, month, day) {
            const mm = String(month + 1).padStart(2, '0');
            const dd = String(day).padStart(2, '0');
            return `${year}-${mm}-${dd}`;
        }

        async function loadMonthEvents() {
            const month = calendarState.month + 1;
            const data = await apiGet(`/api/events?year=${calendarState.year}&month=${month}`);
            const grouped = {};
            (data.events || []).forEach(function(evt) {
                if (!grouped[evt.date_key]) grouped[evt.date_key] = [];
                grouped[evt.date_key].push(evt);
            });
            eventsByDate = grouped;
        }

        function renderCalendar() {
            const title = document.getElementById('calendarTitle');
            const grid = document.getElementById('calendarGrid');
            title.innerText = `Kalender - ${monthNames[calendarState.month]} ${calendarState.year}`;

            grid.innerHTML = `
                <div class="cal-day-header">M</div><div class="cal-day-header">T</div><div class="cal-day-header">O</div>
                <div class="cal-day-header">T</div><div class="cal-day-header">F</div><div class="cal-day-header">L</div><div class="cal-day-header">S</div>
            `;

            const firstDay = new Date(calendarState.year, calendarState.month, 1);
            const daysInMonth = new Date(calendarState.year, calendarState.month + 1, 0).getDate();
            const startOffset = (firstDay.getDay() + 6) % 7; // G√∂r s√∂ndag=6, m√•ndag=0

            for (let i = 0; i < startOffset; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'cal-day';
                emptyDay.innerText = '';
                grid.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = formatDateKey(calendarState.year, calendarState.month, day);
                const events = eventsByDate[dateKey] || [];
                const event = events[0];
                const dayElement = document.createElement('div');
                dayElement.className = events.length ? 'cal-day has-event' : 'cal-day';
                dayElement.innerText = day;

                if (events.length) {
                    dayElement.addEventListener('click', function() {
                        openEventModal({
                            dateLabel: `${day} ${shortMonthNames[calendarState.month]}`,
                            dateKey: dateKey,
                            event: event
                        });
                    });
                }
                grid.appendChild(dayElement);
            }
        }

        async function changeMonth(delta) {
            calendarState.month += delta;
            if (calendarState.month < 0) {
                calendarState.month = 11;
                calendarState.year -= 1;
            } else if (calendarState.month > 11) {
                calendarState.month = 0;
                calendarState.year += 1;
            }
            await loadMonthEvents();
            renderCalendar();
        }

        function formatTimeFromUnix(ts) {
            const d = new Date(ts * 1000);
            return d.toLocaleTimeString('sv-SE', { hour: '2-digit', minute: '2-digit' });
        }

        function formatDateLabel(dateObj) {
            return dateObj.toLocaleDateString('sv-SE', {
                weekday: 'long',
                day: 'numeric',
                month: 'long'
            });
        }

        function renderChatFeed(messages) {
            const feed = document.getElementById('groupChatFeed');
            if (!messages.length) {
                feed.innerHTML = '<div class=\"date-divider\"><span>Inga meddelanden</span></div>';
                return;
            }

            let currentDateKey = '';
            feed.innerHTML = '';
            messages.forEach(function(msg) {
                const dt = new Date(msg.created_at * 1000);
                const dateKey = `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}`;
                if (dateKey !== currentDateKey) {
                    currentDateKey = dateKey;
                    const divider = document.createElement('div');
                    divider.className = 'date-divider';
                    divider.innerHTML = `<span>${formatDateLabel(dt)}</span>`;
                    feed.appendChild(divider);
                }

                const post = document.createElement('div');
                const isMine = msg.email === currentUserEmail;
                post.className = 'chat-post ' + (isMine ? 'mine' : 'theirs');
                const parsed = parseReplyPayload(msg.message);
                const seenBy = (msg.seen_by || []).filter(function(email) { return email !== msg.email; });
                const seenText = isMine && seenBy.length
                    ? `<div class=\"chat-post-seen\">Sett av: ${escapeHtml(seenBy.join(', '))}</div>`
                    : '';
                const replyPreview = parsed.replyTo
                    ? `<div class=\"chat-reply-preview\">Svar p√• ${escapeHtml(parsed.replyTo.author || 'ok√§nd')}: ${escapeHtml(parsed.replyTo.snippet || '')}</div>`
                    : '';
                const replyBtn = !isMine
                    ? `<button class=\"chat-reply-btn\" type=\"button\" title=\"Svara\">‚Ü©</button>`
                    : '';
                post.innerHTML = `
                    <div class=\"chat-post-header\">
                        <strong>${escapeHtml(msg.email)}</strong>
                        <span class=\"chat-post-meta\">
                            <span>${formatTimeFromUnix(msg.created_at)}</span>
                        </span>
                    </div>
                    ${replyPreview}
                    <p>${escapeHtml(parsed.body)}</p>
                    ${replyBtn}
                    ${seenText}
                `;
                const replyBtnEl = post.querySelector('.chat-reply-btn');
                if (replyBtnEl) {
                    replyBtnEl.addEventListener('click', function(e) {
                        e.preventDefault();
                        setActiveReply({
                            author: msg.email,
                            snippet: String(parsed.body || '').slice(0, 80)
                        });
                    });
                }
                feed.appendChild(post);
            });
            feed.scrollTop = feed.scrollHeight;
        }

        function renderActiveThreadInMainChat() {
            if (composeState.active) {
                const titleEl = document.querySelector('.chat-title-main');
                const presenceEl = document.getElementById('groupChatPresence');
                const avatarEl = document.querySelector('.chat-title-avatar');
                const inputEl = document.getElementById('groupChatInput');
                const selected = composeState.selectedIds.map(function(id) { return getThreadById(id); }).filter(Boolean);
                if (titleEl) titleEl.innerText = 'Ny chatt';
                if (presenceEl) presenceEl.innerText = 'V√§lj mottagare';
                if (avatarEl) avatarEl.innerText = '‚úé';
                if (inputEl) inputEl.placeholder = 'Skriv ett meddelande...';
                if (selected.length === 0) {
                    document.getElementById('groupChatFeed').innerHTML = '<div class=\"date-divider\"><span>V√§lj en eller flera mottagare i To:</span></div>';
                } else if (selected.length === 1 && !hasExistingConversation(selected[0])) {
                    document.getElementById('groupChatFeed').innerHTML = `<div class=\"date-divider\"><span>Ingen chatt med ${escapeHtml(selected[0].name)} √§nnu. Skriv nedan och skicka f√∂r att skapa en ny chatt.</span></div>`;
                } else if (selected.length > 1) {
                    document.getElementById('groupChatFeed').innerHTML = '<div class=\"date-divider\"><span>Skicka f√∂rsta meddelandet f√∂r att skapa gruppchatten.</span></div>';
                } else {
                    document.getElementById('groupChatFeed').innerHTML = `<div class=\"date-divider\"><span>Befintlig chatt med ${escapeHtml(selected[0].name)} hittad. Skriv nedan och skicka.</span></div>`;
                }
                setActiveReply(null);
                renderComposeBar();
                return;
            }
            const thread = getThreadById(messengerState.activeThreadId || MESSENGER_GROUP_THREAD_ID);
            if (!thread) return;
            const titleEl = document.querySelector('.chat-title-main');
            const presenceEl = document.getElementById('groupChatPresence');
            const avatarEl = document.querySelector('.chat-title-avatar');
            const inputEl = document.getElementById('groupChatInput');
            const userBadge = document.getElementById('chatCurrentUserBadge');

            if (titleEl) titleEl.innerText = thread.name;
            if (presenceEl) {
                presenceEl.innerText = thread.id === MESSENGER_GROUP_THREAD_ID
                    ? `${Number((window.__presenceCount || 0))} online`
                    : (thread.isGroup ? (thread.statusText || 'Grupp') : (thread.online ? 'Aktiv nu' : 'Offline'));
            }
            if (avatarEl) {
                avatarEl.innerText = thread.id === MESSENGER_GROUP_THREAD_ID
                    ? 'TA'
                    : String(thread.name || '?').slice(0, 2).toUpperCase();
            }
            if (inputEl) {
                inputEl.placeholder = thread.id === MESSENGER_GROUP_THREAD_ID
                    ? 'Skriv i gruppchatten...'
                    : `Skriv till ${thread.name}...`;
            }
            if (userBadge) {
                userBadge.innerText = `Inloggad som: ${currentUserEmail || '-'}`;
            }
            setActiveReply(null);
            renderComposeBar();

            if (thread.id === MESSENGER_GROUP_THREAD_ID) {
                applyChatFilters();
                return;
            }

            const mapped = (thread.messages || []).map(function(m) {
                return {
                    created_at: Math.floor(Number(m.at || 0) / 1000),
                    email: m.from === 'me' ? (currentUserEmail || 'Du') : (m.sender || thread.email || thread.name || 'Ok√§nd'),
                    message: m.text || '',
                    seen_by: []
                };
            });
            renderChatFeed(mapped);
        }

        function applyChatFilters() {
            if ((messengerState.activeThreadId || MESSENGER_GROUP_THREAD_ID) !== MESSENGER_GROUP_THREAD_ID) {
                return;
            }
            const q = document.getElementById('chatSearchText').value.trim().toLowerCase();
            const fromDate = document.getElementById('chatFromDate').value;
            const toDate = document.getElementById('chatToDate').value;
            const fromTs = fromDate ? new Date(`${fromDate}T00:00:00`).getTime() : null;
            const toTs = toDate ? new Date(`${toDate}T23:59:59`).getTime() : null;

            const filtered = allChatMessages.filter(function(msg) {
                const msgMs = msg.created_at * 1000;
                const textOk = !q || msg.message.toLowerCase().includes(q) || msg.email.toLowerCase().includes(q);
                const fromOk = fromTs === null || msgMs >= fromTs;
                const toOk = toTs === null || msgMs <= toTs;
                return textOk && fromOk && toOk;
            });
            renderChatFeed(filtered);
        }

        async function loadChatMessages() {
            return singleFlightLoad('chatMessages', async function() {
                const data = await apiGet('/api/chat/messages?limit=200');
                allChatMessages = data.messages || [];
                if (data.current_user_email) currentUserEmail = data.current_user_email;
                if (messengerState.activeThreadId === MESSENGER_GROUP_THREAD_ID) {
                    markGroupChatRead();
                }
                syncPinnedGroupThreadFromChatMessages();
                if ((messengerState.activeThreadId || MESSENGER_GROUP_THREAD_ID) === MESSENGER_GROUP_THREAD_ID) {
                    applyChatFilters();
                }
                renderMessengerList();
                renderActiveThreadInMainChat();
            });
        }

        async function loadChatPresence() {
            return singleFlightLoad('chatPresence', async function() {
                const data = await apiGet('/api/chat/presence');
                const count = Number(data.online_count || 0);
                window.__presenceCount = count;
                if ((messengerState.activeThreadId || MESSENGER_GROUP_THREAD_ID) === MESSENGER_GROUP_THREAD_ID) {
                    document.getElementById('groupChatPresence').innerText = `${count} online`;
                }
            });
        }

        async function sendGroupChatMessage() {
            const input = document.getElementById('groupChatInput');
            const message = input.value.trim();
            if (!message) return;
            if (composeState.active) {
                const ids = composeState.selectedIds
                    .filter(function(id) { return !!getThreadById(String(id)); });
                if (!ids.length && String(composeState.query || '').trim()) {
                    const q = String(composeState.query || '').trim().toLowerCase();
                    const match = getComposeCandidates().find(function(t) {
                        const n = String(t.name || '').toLowerCase();
                        const e = String(t.email || '').toLowerCase();
                        return n === q || e === q || n.startsWith(q) || e.startsWith(q);
                    });
                    if (match) {
                        ids.push(String(match.id));
                    }
                }
                if (!ids.length) {
                    alert('V√§lj minst en giltig mottagare i To:');
                    return;
                }
                if (ids.length === 1) {
                    await apiSend('/api/messenger/messages', 'POST', {
                        recipient_id: Number(ids[0]),
                        message: message
                    });
                    closeComposeMode();
                    messengerState.activeThreadId = String(ids[0]);
                    await loadMessengerUsers();
                    await loadActiveMessengerThreadMessages();
                    renderActiveThreadInMainChat();
                } else {
                    const response = await apiSend('/api/messenger/groups', 'POST', {
                        name: `Ny chatt (${ids.length + 1})`,
                        invitee_ids: ids.map(function(id) { return Number(id); })
                    });
                    const gid = String(response.group_id || '');
                    await apiSend(`/api/messenger/groups/${gid}/messages`, 'POST', { message: message });
                    closeComposeMode();
                    messengerState.activeThreadId = gid;
                    await loadMessengerUsers();
                    await loadActiveMessengerThreadMessages();
                    renderActiveThreadInMainChat();
                }
                input.value = '';
                return;
            }
            const activeId = messengerState.activeThreadId || MESSENGER_GROUP_THREAD_ID;
            const thread = getThreadById(activeId);
            if (!thread) return;
            const payloadMessage = buildReplyPayload(message, activeReply);

            if (activeId === MESSENGER_GROUP_THREAD_ID) {
                await apiSend('/api/chat/messages', 'POST', { message: payloadMessage });
            } else if (thread.isGroup) {
                await apiSend(`/api/messenger/groups/${thread.id}/messages`, 'POST', { message: payloadMessage });
            } else {
                await apiSend('/api/messenger/messages', 'POST', {
                    recipient_id: Number(thread.id),
                    message: payloadMessage
                });
            }
            input.value = '';
            setActiveReply(null);
            if (activeId === MESSENGER_GROUP_THREAD_ID) {
                await loadChatMessages();
            } else {
                await loadActiveMessengerThreadMessages();
                renderActiveThreadInMainChat();
            }
            await loadMessengerUsers();
        }

        async function loadNotes() {
            const data = await apiGet('/api/notes/me');
            document.getElementById('notesArea').value = data.content || '';
        }

        async function saveNotes() {
            const content = document.getElementById('notesArea').value;
            await apiSend('/api/notes/me', 'PUT', { content: content });
        }

        function initNotes() {
            document.getElementById('notesArea').addEventListener('input', function() {
                clearTimeout(notesSaveTimer);
                notesSaveTimer = setTimeout(function() {
                    saveNotes().catch(function() {});
                }, 500);
            });
        }

        async function loadTodayMeetings() {
            return singleFlightLoad('todayMeetings', async function() {
                const data = await apiGet('/api/meetings/today');
                const meetings = data.meetings || [];
                const list = document.getElementById('meetingsList');
                if (!meetings.length) {
                    list.innerHTML = '<div class=\"meeting-item\"><span>Inga m√∂ten idag</span><span></span></div>';
                    return;
                }
                list.innerHTML = meetings.map(function(m) {
                    const link = m.link || '#';
                    const editBtn = currentUserIsAdmin
                        ? `<button class=\"meeting-edit-btn\" type=\"button\" data-edit-event-id=\"${m.id}\" title=\"Redigera\">‚úèÔ∏è</button>`
                        : '';
                    return `
                        <div class=\"meeting-item\">
                            <span>${escapeHtml(m.title)}</span>
                            <span class=\"meeting-actions\">
                                <a class=\"meeting-link\" href=\"${link}\" target=\"_blank\" title=\"Anslut till m√∂tet\">üé•</a>
                                ${editBtn}
                            </span>
                        </div>
                    `;
                }).join('');

                if (currentUserIsAdmin) {
                    list.querySelectorAll('[data-edit-event-id]').forEach(function(btn) {
                        btn.addEventListener('click', function() {
                            const id = Number(btn.getAttribute('data-edit-event-id'));
                            const match = meetings.find(function(x) { return x.id === id; });
                            openEventEditorEdit(match);
                        });
                    });
                }
            });
        }

        function initGroupChat() {
            document.getElementById('groupChatSendBtn').addEventListener('click', function() {
                sendGroupChatMessage().catch(function() {});
            });
            document.getElementById('groupChatInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    const text = String(e.target.value || '').trim();
                    if (!text) return;
                    sendGroupChatMessage().catch(function() {});
                }
            });
            document.getElementById('chatSearchBtn').addEventListener('click', applyChatFilters);
            document.getElementById('chatSearchText').addEventListener('input', applyChatFilters);
            document.getElementById('chatFromDate').addEventListener('change', applyChatFilters);
            document.getElementById('chatToDate').addEventListener('change', applyChatFilters);
        }

        // JS f√∂r kalender modal
        function openEventModal(payload) {
            const event = payload.event;
            activeModalEvent = {
                id: event.id,
                date_key: payload.dateKey,
                title: event.title,
                link: event.link || ''
            };
            document.getElementById('modalDate').innerText = payload.dateKey;
            document.getElementById('modalTitle').innerText = event.title;
            document.getElementById('modalLink').href = event.link || '#';
            document.getElementById('eventModal').style.display = 'flex';
            const editBtn = document.getElementById('modalEditEventBtn');
            editBtn.style.display = currentUserIsAdmin ? 'inline-block' : 'none';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        // St√§ng modal om man klickar utanf√∂r rutan
        document.getElementById('eventModal').addEventListener('click', function(e) {
            if(e.target === this) closeModal();
        });

        function openEventEditorCreate() {
            eventEditorMode = 'create';
            editingEventId = null;
            document.getElementById('eventEditorTitle').innerText = 'Nytt m√∂te';
            const today = new Date();
            const todayKey = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            document.getElementById('eventEditorDate').value = todayKey;
            document.getElementById('eventEditorText').value = '';
            document.getElementById('eventEditorLink').value = '';
            document.getElementById('eventEditorModal').style.display = 'flex';
        }

        function openEventEditorEdit(eventObj) {
            if (!eventObj) return;
            eventEditorMode = 'edit';
            editingEventId = eventObj.id;
            document.getElementById('eventEditorTitle').innerText = 'Redigera m√∂te';
            document.getElementById('eventEditorDate').value = eventObj.date_key;
            document.getElementById('eventEditorText').value = eventObj.title || '';
            document.getElementById('eventEditorLink').value = eventObj.link || '';
            document.getElementById('eventEditorModal').style.display = 'flex';
        }

        function closeEventEditor() {
            document.getElementById('eventEditorModal').style.display = 'none';
        }

        async function saveEventFromEditor() {
            const dateKey = document.getElementById('eventEditorDate').value;
            const title = document.getElementById('eventEditorText').value.trim();
            const link = document.getElementById('eventEditorLink').value.trim();
            if (!dateKey || !title) {
                alert('Datum och titel kr√§vs.');
                return;
            }
            if (!/^\d{4}-\d{2}-\d{2}$/.test(dateKey)) {
                alert('Datum m√•ste vara i formatet YYYY-MM-DD.');
                return;
            }

            const [yearStr, monthStr] = dateKey.split('-');
            const eventsForMonth = await apiGet(`/api/events?year=${Number(yearStr)}&month=${Number(monthStr)}`);
            const collisions = (eventsForMonth.events || []).filter(function(evt) {
                if (String(evt.date_key || '') !== dateKey) return false;
                if (eventEditorMode === 'edit' && editingEventId && Number(evt.id) === Number(editingEventId)) return false;
                return true;
            });
            if (collisions.length > 0) {
                const existingTitles = collisions
                    .slice(0, 3)
                    .map(function(evt) { return String(evt.title || 'M√∂te'); })
                    .join(', ');
                const message = `Varning: Det finns redan ${collisions.length} m√∂te(n) ${dateKey}${existingTitles ? ` (${existingTitles})` : ''}. Vill du spara √§nd√•?`;
                if (!window.confirm(message)) return;
            }

            if (eventEditorMode === 'edit' && editingEventId) {
                await apiSend(`/api/events/${editingEventId}`, 'PUT', {
                    date_key: dateKey,
                    title: title,
                    link: link
                });
            } else {
                await apiSend('/api/events', 'POST', {
                    date_key: dateKey,
                    title: title,
                    link: link
                });
            }

            closeEventEditor();
            closeModal();
            await Promise.all([loadMonthEvents(), loadTodayMeetings()]);
            renderCalendar();
        }

        async function openFolderModal() {
            document.getElementById('folderModal').style.display = 'flex';
            try {
                await fsLoadState(true);
            } catch (err) {
            }
            fsRender();
        }

        function closeFolderModal() {
            document.getElementById('folderModal').style.display = 'none';
            document.getElementById('fsContextMenu').style.display = 'none';
            fsCloseShareModal();
            fsCloseEditor();
        }

        let fsModel = {
            name: 'root',
            type: 'folder',
            created_by_email: 'admin',
            created_by_admin: true,
            children: {
                'Gemensam mapp': {
                    type: 'folder',
                    created_by_email: 'admin',
                    created_by_admin: true,
                    children: {
                        'Projektplan.pdf': {
                            type: 'file',
                            content: 'Projektplan version 1.2',
                            created_by_email: 'admin',
                            created_by_admin: true
                        },
                        'Roadmap.txt': {
                            type: 'file',
                            content: 'Q1: Planering\nQ2: Leverans',
                            created_by_email: 'admin',
                            created_by_admin: true
                        }
                    }
                },
                'Privat': {
                    type: 'folder',
                    created_by_email: 'admin',
                    created_by_admin: true,
                    children: {},
                    user_homes: {
                        admin: {
                            type: 'folder',
                            created_by_email: 'admin',
                            created_by_admin: true,
                            children: {
                                'Anteckningar.txt': {
                                    type: 'file',
                                    content: 'Mina privata anteckningar.',
                                    created_by_email: 'admin',
                                    created_by_admin: true
                                }
                            }
                        }
                    }
                },
                'Delat med mig': {
                    type: 'folder',
                    created_by_email: 'admin',
                    created_by_admin: true,
                    children: {},
                    user_homes: {}
                }
            }
        };
        let fsCurrentPath = [];
        let fsOpenFileName = null;
        let fsContextTargetName = null;
        let fsShareTargetName = null;
        let fsNodeIdSeq = 1;
        let fsRefreshTimer = null;
        let fsSyncInFlight = null;
        let fsStateLoaded = false;
        const FS_REFRESH_ACTIVE_MS = 5000;
        const FS_REFRESH_BG_MS = 15000;
        const FS_REFRESH_IDLE_MS = 30000;
        const fsFileDisplay = document.getElementById('fsFileDisplay');
        const fsContextMenu = document.getElementById('fsContextMenu');
        const fsAddressBar = document.getElementById('fsAddressBar');
        const fsEditorOverlay = document.getElementById('fsEditorOverlay');
        const fsTextContent = document.getElementById('fsTextContent');
        const fsEditorFilename = document.getElementById('fsEditorFilename');
        const fsSaveBtn = document.getElementById('fsSaveBtn');
        const fsShareOverlay = document.getElementById('fsShareOverlay');
        const fsShareTitle = document.getElementById('fsShareTitle');
        const fsShareList = document.getElementById('fsShareList');

        function fsNormalizeEmail(email) {
            return String(email || '').trim().toLowerCase();
        }

        function fsIsModalOpen() {
            const modal = document.getElementById('folderModal');
            return !!modal && modal.style.display === 'flex';
        }

        function fsGetRefreshDelay() {
            if (!fsIsModalOpen()) return FS_REFRESH_IDLE_MS;
            return document.hidden ? FS_REFRESH_BG_MS : FS_REFRESH_ACTIVE_MS;
        }

        function fsScheduleAutoRefresh(immediate) {
            if (fsRefreshTimer) clearTimeout(fsRefreshTimer);
            const delay = immediate ? 0 : fsGetRefreshDelay();
            fsRefreshTimer = setTimeout(async function() {
                if (fsIsModalOpen()) {
                    try {
                        await fsLoadState(true);
                    } catch (err) {
                    }
                    fsRender();
                }
                fsScheduleAutoRefresh(false);
            }, delay);
        }

        function startFsAutoRefresh() {
            fsScheduleAutoRefresh(false);
        }

        function refreshFsAutoRefreshSoon() {
            fsScheduleAutoRefresh(true);
        }

        async function fsLoadState(force) {
            if (!force && fsStateLoaded) return;
            if (fsSyncInFlight) return fsSyncInFlight;
            fsSyncInFlight = (async function() {
                const data = await apiGet('/api/fs/state');
                if (data && data.state && typeof data.state === 'object') {
                    fsModel = data.state;
                    fsEnsureNodeIds(fsModel);
                    fsStateLoaded = true;
                }
            })();
            try {
                await fsSyncInFlight;
            } finally {
                fsSyncInFlight = null;
            }
        }

        async function fsPersistState() {
            await apiSend('/api/fs/state', 'PUT', { state: fsModel });
        }

        function fsCurrentUserEmail() {
            return fsNormalizeEmail(currentUserEmail);
        }

        function fsCurrentUserKey() {
            return fsCurrentUserEmail() || '__guest__';
        }

        function fsIsSharedPath(pathParts) {
            return Array.isArray(pathParts) && pathParts[0] === 'Gemensam mapp';
        }

        function fsIsPrivatePath(pathParts) {
            return Array.isArray(pathParts) && pathParts[0] === 'Privat';
        }

        function fsIsAdminCreated(item) {
            if (!item) return false;
            if (item.created_by_admin) return true;
            return String(item.created_by_email || '').trim().toLowerCase() === 'admin';
        }

        function fsCanModifyItem(item, itemPathParts) {
            const inheritedSharePermission = fsGetInheritedSharePermission(itemPathParts);
            if (inheritedSharePermission) {
                return inheritedSharePermission === 'edit';
            }
            if (item && item.shared_link) {
                return String(item.share_permission || 'read') === 'edit';
            }
            if (currentUserIsAdmin) return true;
            if (fsIsAdminCreated(item)) return false;
            if (fsIsSharedPath(itemPathParts)) return true;
            return true;
        }

        function fsCreateNode(type) {
            const isFile = type === 'file';
            return {
                type: type,
                content: isFile ? '' : null,
                children: isFile ? null : {},
                created_by_email: fsCurrentUserEmail() || 'unknown',
                created_by_admin: !!currentUserIsAdmin
            };
        }

        function fsEnsureNodeId(node) {
            if (!node) return '';
            if (!node.__fs_id) {
                node.__fs_id = `node_${fsNodeIdSeq++}`;
            }
            return node.__fs_id;
        }

        function fsResolveNode(node) {
            if (!node) return null;
            return node.shared_link ? node.source : node;
        }

        function fsEnsureNodeIds(node) {
            if (!node) return;
            fsEnsureNodeId(node);
            if (node.type !== 'folder' || !node.children) return;
            Object.keys(node.children).forEach(function(name) {
                const child = fsResolveNode(node.children[name]);
                fsEnsureNodeIds(child);
            });
        }

        function fsGetPrivateHomeByUser(userEmail, createIfMissing) {
            const privatRoot = fsModel.children['Privat'];
            if (!privatRoot) return null;
            if (!privatRoot.user_homes) privatRoot.user_homes = {};
            const key = fsNormalizeEmail(userEmail) || '__guest__';
            if (!privatRoot.user_homes[key] && createIfMissing !== false) {
                privatRoot.user_homes[key] = {
                    type: 'folder',
                    created_by_email: key,
                    created_by_admin: key === 'admin',
                    children: {}
                };
                fsEnsureNodeId(privatRoot.user_homes[key]);
            }
            return privatRoot.user_homes[key] || null;
        }

        function fsGetPrivateHome(createIfMissing) {
            return fsGetPrivateHomeByUser(fsCurrentUserKey(), createIfMissing);
        }

        function fsGetSharedHomeByUser(userEmail, createIfMissing) {
            const sharedRoot = fsModel.children['Delat med mig'];
            if (!sharedRoot) return null;
            if (!sharedRoot.user_homes) sharedRoot.user_homes = {};
            const key = fsNormalizeEmail(userEmail) || '__guest__';
            if (!sharedRoot.user_homes[key] && createIfMissing !== false) {
                sharedRoot.user_homes[key] = {
                    type: 'folder',
                    created_by_email: key,
                    created_by_admin: key === 'admin',
                    children: {}
                };
                fsEnsureNodeId(sharedRoot.user_homes[key]);
            }
            return sharedRoot.user_homes[key] || null;
        }

        function fsGetSharedHome(createIfMissing) {
            return fsGetSharedHomeByUser(fsCurrentUserKey(), createIfMissing);
        }

        function fsMakeShareLinkName(baseName, ownerEmail, targetHome) {
            const ownerLabel = String(ownerEmail || '').split('@')[0] || ownerEmail || 'ok√§nd';
            const base = `${baseName} (delad av ${ownerLabel})`;
            if (!targetHome.children[base]) return base;
            let i = 2;
            while (targetHome.children[`${base} ${i}`]) i += 1;
            return `${base} ${i}`;
        }

        function fsUpsertShareLink(sourceNode, sourceName, recipientEmail, permission) {
            const recipient = fsNormalizeEmail(recipientEmail);
            if (!recipient) return;
            const recipientHome = fsGetSharedHomeByUser(recipient, true);
            if (!recipientHome) return;
            const sourceId = fsEnsureNodeId(sourceNode);
            const existing = Object.keys(recipientHome.children).find(function(name) {
                const item = recipientHome.children[name];
                return !!item && item.shared_link && item.shared_source_id === sourceId;
            });
            const linkName = existing || fsMakeShareLinkName(sourceName, sourceNode.created_by_email, recipientHome);
            recipientHome.children[linkName] = {
                type: sourceNode.type,
                shared_link: true,
                shared_source_id: sourceId,
                source: sourceNode,
                source_owner_email: fsNormalizeEmail(sourceNode.created_by_email),
                share_permission: permission === 'edit' ? 'edit' : 'read',
                created_by_email: fsCurrentUserEmail() || 'unknown',
                created_by_admin: !!currentUserIsAdmin
            };
        }

        async function fsGetShareCandidates() {
            try {
                const data = await apiGet('/api/users');
                return (data.users || [])
                    .map(function(u) {
                        const email = fsNormalizeEmail(u.email);
                        return { email: email, label: messengerDisplayName(email) || email };
                    })
                    .filter(function(u) { return !!u.email && u.email !== fsCurrentUserEmail(); });
            } catch (err) {
                const map = {};
                messengerThreads.forEach(function(t) {
                    if (!t || t.isGroup) return;
                    const email = fsNormalizeEmail(t.email);
                    if (!email || email === fsCurrentUserEmail()) return;
                    map[email] = { email: email, label: t.name || email };
                });
                return Object.keys(map).sort().map(function(k) { return map[k]; });
            }
        }

        function fsCanShareItem(item, itemPathParts) {
            if (!item) return false;
            if (item.shared_link) return false;
            if (!fsIsPrivatePath(itemPathParts)) return false;
            if (fsGetInheritedSharePermission(itemPathParts)) return false;
            return fsCanModifyItem(item, itemPathParts);
        }

        function fsCloseShareModal() {
            fsShareOverlay.style.display = 'none';
            fsShareTargetName = null;
            fsShareList.innerHTML = '';
        }

        async function fsOpenShareModalForContextTarget() {
            if (!fsContextTargetName) return;
            const folder = fsGetCurrentFolder();
            const item = folder ? folder.children[fsContextTargetName] : null;
            if (!item) return;
            if (!fsCanShareItem(item, fsCurrentPath.concat([fsContextTargetName]))) {
                alert('Det h√§r objektet kan inte delas.');
                return;
            }

            fsShareTargetName = fsContextTargetName;
            const candidates = await fsGetShareCandidates();
            fsShareTitle.innerText = `Dela: ${fsShareTargetName}`;
            if (!candidates.length) {
                fsShareList.innerHTML = '<div class="fs-share-empty">Inga anv√§ndare att dela med.</div>';
                fsShareOverlay.style.display = 'flex';
                return;
            }

            fsShareList.innerHTML = candidates.map(function(user) {
                return `
                    <label class="fs-share-item">
                        <input type="checkbox" data-share-email="${escapeHtml(user.email)}">
                        <div>
                            <div class="fs-share-name">${escapeHtml(user.label)}</div>
                            <div class="fs-share-email">${escapeHtml(user.email)}</div>
                        </div>
                        <select class="fs-share-perm" data-share-perm-for="${escapeHtml(user.email)}" disabled>
                            <option value="read">Kan l√§sa</option>
                            <option value="edit">Kan redigera</option>
                        </select>
                    </label>
                `;
            }).join('');

            fsShareList.querySelectorAll('input[type="checkbox"][data-share-email]').forEach(function(cb) {
                cb.addEventListener('change', function() {
                    const email = cb.getAttribute('data-share-email');
                    const select = fsShareList.querySelector(`select[data-share-perm-for="${email}"]`);
                    if (select) select.disabled = !cb.checked;
                });
            });
            fsShareOverlay.style.display = 'flex';
        }

        async function fsApplyShare() {
            if (!fsShareTargetName) return;
            const folder = fsGetCurrentFolder();
            const item = folder ? folder.children[fsShareTargetName] : null;
            if (!item) {
                fsCloseShareModal();
                return;
            }
            const sourceNode = fsResolveNode(item);
            const sourceName = fsShareTargetName;
            if (!sourceNode) return;
            fsEnsureNodeId(sourceNode);
            if (!sourceNode.shared_with) sourceNode.shared_with = {};

            const selected = Array.from(fsShareList.querySelectorAll('input[type="checkbox"][data-share-email]:checked'));
            if (!selected.length) {
                alert('V√§lj minst en person att dela med.');
                return;
            }

            selected.forEach(function(cb) {
                const email = fsNormalizeEmail(cb.getAttribute('data-share-email'));
                if (!email) return;
                const sel = fsShareList.querySelector(`select[data-share-perm-for="${cb.getAttribute('data-share-email')}"]`);
                const perm = sel && sel.value === 'edit' ? 'edit' : 'read';
                sourceNode.shared_with[email] = perm;
                fsUpsertShareLink(sourceNode, sourceName, email, perm);
            });
            try {
                await fsPersistState();
            } catch (err) {
                alert('Kunde inte spara delningen.');
                return;
            }

            fsCloseShareModal();
            fsContextMenu.style.display = 'none';
            alert('Delning uppdaterad.');
        }

        function fsGetCurrentFolder() {
            let folder = fsModel;
            for (let i = 0; i < fsCurrentPath.length; i++) {
                const part = fsCurrentPath[i];
                if (!folder || !folder.children) return null;
                if (i === 0 && part === 'Privat') {
                    folder = fsGetPrivateHome(true);
                    continue;
                }
                if (i === 0 && part === 'Delat med mig') {
                    folder = fsGetSharedHome(true);
                    continue;
                }
                const next = folder.children[part];
                folder = fsResolveNode(next);
            }
            return folder;
        }

        function fsGetInheritedSharePermission(pathParts) {
            if (!fsIsPrivatePath(pathParts)) return null;
            const privateHome = fsGetPrivateHome(true);
            if (!privateHome || !privateHome.children || pathParts.length < 2) return null;
            const top = privateHome.children[pathParts[1]];
            if (!top || !top.shared_link) return null;
            return String(top.share_permission || 'read');
        }

        function fsUpdateContextMenuState() {
            const share = document.getElementById('fsShareItemMenu');
            const del = document.getElementById('fsDeleteItemMenu');
            if (!del) return;
            if (!fsContextTargetName) {
                if (share) share.classList.add('disabled');
                del.classList.add('disabled');
                return;
            }
            const folder = fsGetCurrentFolder();
            const item = folder.children[fsContextTargetName];
            const canDelete = !!item && fsCanModifyItem(item, fsCurrentPath.concat([fsContextTargetName]));
            const canShare = !!item && fsCanShareItem(item, fsCurrentPath.concat([fsContextTargetName]));
            if (share) share.classList.toggle('disabled', !canShare);
            del.classList.toggle('disabled', !canDelete);
        }

        function fsRender() {
            const folder = fsGetCurrentFolder();
            if (!folder) return;
            fsFileDisplay.innerHTML = '';
            if (fsIsPrivatePath(fsCurrentPath)) {
                fsAddressBar.innerText = 'Denna dator > Privat (' + (fsCurrentUserEmail() || 'ok√§nd anv√§ndare') + ')';
            } else if (Array.isArray(fsCurrentPath) && fsCurrentPath[0] === 'Delat med mig') {
                fsAddressBar.innerText = 'Denna dator > Delat med mig (' + (fsCurrentUserEmail() || 'ok√§nd anv√§ndare') + ')';
            } else {
                fsAddressBar.innerText = 'Denna dator > ' + (fsCurrentPath.join(' > ') || 'Dokument');
            }

            Object.keys(folder.children).forEach(function(name) {
                const item = folder.children[name];
                const icon = item.type === 'folder' ? 'üìÅ' : 'üìÑ';
                const div = document.createElement('div');
                div.className = 'fs-item';
                div.setAttribute('data-fs-name', name);
                const sharedMark = item.shared_link ? ' üîó' : '';
                div.innerHTML = `
                    <div class="fs-item-icon">${icon}</div>
                    <div class="fs-item-name">${name}${sharedMark}</div>
                `;
                div.onclick = function() {
                    const target = fsResolveNode(item);
                    if (target && target.type === 'folder') {
                        fsCurrentPath.push(name);
                        fsRender();
                    } else {
                        fsOpenFile(name);
                    }
                };
                fsFileDisplay.appendChild(div);
            });
        }

        function fsGoBack() {
            if (fsCurrentPath.length > 0) {
                fsCurrentPath.pop();
                fsRender();
            }
        }

        async function fsCreateNewItem(type) {
            if (Array.isArray(fsCurrentPath) && fsCurrentPath[0] === 'Delat med mig') {
                alert('Du kan inte skapa nya filer eller mappar i Delat med mig.');
                return;
            }
            if (!fsCanModifyItem(null, fsCurrentPath)) {
                alert('Du har bara l√§sbeh√∂righet h√§r.');
                return;
            }
            const rawName = prompt(type === 'folder' ? 'Ange mappnamn:' : 'Ange filnamn:');
            const name = String(rawName || '').trim();
            if (!name) return;

            const folder = fsGetCurrentFolder();
            if (folder.children[name]) {
                alert('Namnet finns redan!');
                return;
            }

            folder.children[name] = fsCreateNode(type);
            fsContextMenu.style.display = 'none';
            fsContextTargetName = null;
            try {
                await fsPersistState();
            } catch (err) {
                alert('Kunde inte spara √§ndringen.');
                return;
            }
            fsRender();
        }

        function fsOpenFile(name) {
            const folder = fsGetCurrentFolder();
            const item = folder.children[name];
            const target = fsResolveNode(item);
            if (!item || !target || target.type !== 'file') return;
            fsOpenFileName = name;
            fsEditorFilename.innerText = name;
            fsTextContent.value = target.content || '';
            const canEdit = fsCanModifyItem(item, fsCurrentPath.concat([name]));
            fsTextContent.readOnly = !canEdit;
            if (fsSaveBtn) {
                fsSaveBtn.disabled = !canEdit;
                fsSaveBtn.title = canEdit ? '' : 'Detta dokument √§r l√•st f√∂r vanliga anv√§ndare.';
            }
            fsEditorOverlay.style.display = 'flex';
        }

        function fsCloseEditor() {
            fsEditorOverlay.style.display = 'none';
            fsOpenFileName = null;
            fsTextContent.readOnly = false;
            if (fsSaveBtn) {
                fsSaveBtn.disabled = false;
                fsSaveBtn.title = '';
            }
        }

        async function fsSaveFile() {
            const folder = fsGetCurrentFolder();
            if (!fsOpenFileName || !folder.children[fsOpenFileName]) return;
            const item = folder.children[fsOpenFileName];
            const target = fsResolveNode(item);
            if (!fsCanModifyItem(item, fsCurrentPath.concat([fsOpenFileName]))) {
                alert('Du kan inte √§ndra dokument som admin har skapat.');
                return;
            }
            if (!target || target.type !== 'file') return;
            target.content = fsTextContent.value;
            try {
                await fsPersistState();
            } catch (err) {
                alert('Kunde inte spara filen p√• servern.');
                return;
            }
            fsCloseEditor();
            alert('Filen sparades!');
        }

        async function fsDeleteContextTarget() {
            if (!fsContextTargetName) return;
            const folder = fsGetCurrentFolder();
            const item = folder.children[fsContextTargetName];
            if (!item) {
                fsContextTargetName = null;
                fsContextMenu.style.display = 'none';
                fsRender();
                return;
            }
            if (item.shared_link) {
                const source = fsResolveNode(item);
                const me = fsCurrentUserEmail();
                if (source && source.shared_with && me) {
                    delete source.shared_with[me];
                }
                delete folder.children[fsContextTargetName];
                try {
                    await fsPersistState();
                } catch (err) {
                    alert('Kunde inte spara √§ndringen.');
                    return;
                }
                fsContextTargetName = null;
                fsContextMenu.style.display = 'none';
                fsRender();
                return;
            }
            if (!fsCanModifyItem(item, fsCurrentPath.concat([fsContextTargetName]))) {
                alert('Du kan inte ta bort mappar eller dokument som admin har skapat.');
                return;
            }
            const label = item.type === 'folder' ? 'mappen' : 'filen';
            const ok = window.confirm(`Vill du ta bort ${label} "${fsContextTargetName}"?`);
            if (!ok) return;
            delete folder.children[fsContextTargetName];
            try {
                await fsPersistState();
            } catch (err) {
                alert('Kunde inte spara √§ndringen.');
                return;
            }
            fsContextTargetName = null;
            fsContextMenu.style.display = 'none';
            fsRender();
        }

        document.getElementById('folderModal').addEventListener('click', function(e) {
            if (e.target === this) closeFolderModal();
        });
        fsShareOverlay.addEventListener('click', function(e) {
            if (e.target === fsShareOverlay) fsCloseShareModal();
        });
        fsFileDisplay.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const itemEl = e.target.closest('.fs-item');
            fsContextTargetName = itemEl ? String(itemEl.getAttribute('data-fs-name') || '') : null;
            fsUpdateContextMenuState();
            fsContextMenu.style.display = 'block';
            const bounds = document.querySelector('.folder-modal-content').getBoundingClientRect();
            fsContextMenu.style.left = (e.clientX - bounds.left) + 'px';
            fsContextMenu.style.top = (e.clientY - bounds.top) + 'px';
        });
        document.addEventListener('click', function(e) {
            if (!fsContextMenu.contains(e.target)) {
                fsContextMenu.style.display = 'none';
                fsContextTargetName = null;
            }
        });
        fsEnsureNodeIds(fsModel);

        const messengerState = {
            activeThreadId: null,
            filter: ''
        };
        const MESSENGER_GROUP_THREAD_ID = 'group-all';
        let groupChatLastReadId = Number(localStorage.getItem('group_chat_last_read_id') || 0);
        let messengerThreads = [];
        let activeReply = null;
        let threadLoadSeq = 0;
        const composeState = {
            active: false,
            selectedIds: [],
            query: ''
        };

        function messengerDisplayName(email) {
            const local = String(email || '').split('@')[0] || String(email || '');
            return local
                .replace(/[._-]+/g, ' ')
                .trim()
                .replace(/\b\w/g, function(ch) { return ch.toUpperCase(); }) || String(email || '');
        }

        function messengerAvatarUrl(email) {
            return `https://api.dicebear.com/9.x/initials/svg?seed=${encodeURIComponent(email)}`;
        }

        function getLatestGroupChatMessageId() {
            if (!allChatMessages.length) return 0;
            return Number(allChatMessages[allChatMessages.length - 1].id || 0);
        }

        function parseReplyPayload(text) {
            const raw = String(text || '');
            const match = raw.match(/^\[reply\|([^\]|]*)\|([^\]]*)\]\n?([\s\S]*)$/);
            if (!match) return { body: raw, replyTo: null };
            return {
                body: match[3] || '',
                replyTo: {
                    author: match[1] || '',
                    snippet: match[2] || ''
                }
            };
        }

        function buildReplyPayload(body, replyMeta) {
            const cleanBody = String(body || '').trim();
            if (!replyMeta) return cleanBody;
            const author = String(replyMeta.author || '').replace(/\|/g, '/');
            const snippet = String(replyMeta.snippet || '').replace(/\|/g, '/');
            return `[reply|${author}|${snippet}]\n${cleanBody}`;
        }

        function setActiveReply(replyMeta) {
            activeReply = replyMeta || null;
            const bar = document.getElementById('chatReplyBar');
            const text = document.getElementById('chatReplyText');
            if (!bar || !text) return;
            if (!activeReply) {
                bar.style.display = 'none';
                text.innerText = '';
                return;
            }
            bar.style.display = 'flex';
            text.innerText = `Svarar p√• ${activeReply.author}: ${activeReply.snippet}`;
        }

        function getComposeCandidates() {
            return messengerThreads.filter(function(t) {
                return !t.isGroup && t.id !== MESSENGER_GROUP_THREAD_ID;
            });
        }

        function openComposeMode() {
            composeState.active = true;
            composeState.selectedIds = [];
            composeState.query = '';
            messengerState.activeThreadId = null;
            renderComposeBar();
            renderMainChatThreadList();
            renderActiveThreadInMainChat();
        }

        function closeComposeMode() {
            composeState.active = false;
            composeState.selectedIds = [];
            composeState.query = '';
            hideComposeSuggestions();
            renderComposeBar();
        }

        function renderComposeBar() {
            const top = document.getElementById('chatComposeTop');
            const recipients = document.getElementById('chatComposeRecipients');
            if (!top || !recipients) return;

            if (!composeState.active) {
                top.style.display = 'none';
                recipients.innerHTML = '';
                return;
            }
            top.style.display = 'block';
            const candidates = getComposeCandidates();
            const selected = candidates.filter(function(t) { return composeState.selectedIds.includes(String(t.id)); });
            const chips = selected.map(function(t) {
                return `<span class="chat-compose-chip">${escapeHtml(t.name)}<button type="button" data-remove-compose-id="${t.id}" title="Ta bort">√ó</button></span>`;
            }).join('');
            recipients.innerHTML = chips + `<input id="chatComposeInput" class="chat-compose-input" type="text" placeholder="Skriv ett namn..." value="${escapeHtml(composeState.query)}">`;

            recipients.querySelectorAll('[data-remove-compose-id]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    const id = String(btn.getAttribute('data-remove-compose-id'));
                    composeState.selectedIds = composeState.selectedIds.filter(function(x) { return x !== id; });
                    renderComposeBar();
                    renderComposeSuggestions();
                });
            });

            const input = document.getElementById('chatComposeInput');
            if (!input) return;
            input.addEventListener('input', function() {
                composeState.query = input.value;
                renderComposeSuggestions();
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !composeState.query && composeState.selectedIds.length) {
                    composeState.selectedIds.pop();
                    renderComposeBar();
                    renderComposeSuggestions();
                }
                if (e.key === ' ') {
                    const exact = findExactComposeCandidate(composeState.query);
                    if (exact) {
                        e.preventDefault();
                        addComposeRecipient(String(exact.id));
                    }
                }
                if (e.key === 'Enter' || e.key === 'Tab' || e.key === ',') {
                    e.preventDefault();
                    const exact = findExactComposeCandidate(composeState.query);
                    if (exact) {
                        addComposeRecipient(String(exact.id));
                        return;
                    }
                    const filtered = filterComposeCandidates();
                    if (filtered.length) {
                        addComposeRecipient(String(filtered[0].id));
                    }
                }
            });
            input.focus();
            renderComposeSuggestions();
        }

        function filterComposeCandidates() {
            const q = String(composeState.query || '').trim().toLowerCase();
            return getComposeCandidates().filter(function(t) {
                if (composeState.selectedIds.includes(String(t.id))) return false;
                if (!q) return true;
                const hay = `${t.name} ${t.email}`.toLowerCase();
                return hay.includes(q);
            });
        }

        function findExactComposeCandidate(query) {
            const q = String(query || '').trim().toLowerCase();
            if (!q) return null;
            return getComposeCandidates().find(function(t) {
                if (composeState.selectedIds.includes(String(t.id))) return false;
                const name = String(t.name || '').toLowerCase();
                const email = String(t.email || '').toLowerCase();
                const local = String(t.email || '').split('@')[0].toLowerCase();
                return name === q || email === q || local === q;
            }) || null;
        }

        function hasExistingConversation(thread) {
            if (!thread || thread.isGroup) return false;
            if ((thread.messages || []).length > 0) return true;
            if (Number(thread.updatedAt || 0) > 0) return true;
            const preview = String(thread.lastPreview || '').trim().toLowerCase();
            return !!preview && preview !== 'inga meddelanden √§n.';
        }

        function addComposeRecipient(id) {
            if (!composeState.selectedIds.includes(id)) {
                composeState.selectedIds.push(id);
            }
            composeState.query = '';
            renderComposeBar();
        }

        function hideComposeSuggestions() {
            const box = document.getElementById('chatComposeSuggestions');
            if (box) box.style.display = 'none';
        }

        function renderComposeSuggestions() {
            const box = document.getElementById('chatComposeSuggestions');
            if (!box || !composeState.active) return;
            const filtered = filterComposeCandidates();
            if (!composeState.query.trim() || !filtered.length) {
                box.style.display = 'none';
                box.innerHTML = '';
                return;
            }
            box.innerHTML = filtered.slice(0, 8).map(function(t) {
                return `<button class="chat-compose-suggestion" type="button" data-compose-id="${t.id}">${escapeHtml(t.name)} (${escapeHtml(t.email)})</button>`;
            }).join('');
            box.style.display = 'block';
            box.querySelectorAll('[data-compose-id]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    addComposeRecipient(String(btn.getAttribute('data-compose-id')));
                });
            });
        }

        function getGroupUnreadCount() {
            return allChatMessages.filter(function(msg) {
                const id = Number(msg.id || 0);
                return id > groupChatLastReadId && msg.email !== currentUserEmail;
            }).length;
        }

        function markGroupChatRead() {
            groupChatLastReadId = getLatestGroupChatMessageId();
            localStorage.setItem('group_chat_last_read_id', String(groupChatLastReadId));
        }

        function syncPinnedGroupThreadFromChatMessages() {
            const thread = getThreadById(MESSENGER_GROUP_THREAD_ID);
            if (!thread) return;
            const sourceMessages = (allChatMessages || []).map(function(msg) {
                const isMine = msg.email === currentUserEmail;
                return {
                    from: isMine ? 'me' : 'them',
                    sender: msg.email,
                    text: msg.message,
                    at: Number(msg.created_at || 0) * 1000
                };
            });
            thread.messages = sourceMessages;
            const last = sourceMessages[sourceMessages.length - 1];
            thread.updatedAt = last ? Number(last.at) : 0;
            thread.lastPreview = last
                ? ((last.from === 'me' ? 'Du: ' : '') + String(last.text || ''))
                : 'Inga meddelanden √§n.';
            thread.unread = getGroupUnreadCount();
        }

        function buildPinnedGroupThread(existingGroup) {
            const sourceMessages = (allChatMessages || []).map(function(msg) {
                const isMine = msg.email === currentUserEmail;
                return {
                    from: isMine ? 'me' : 'them',
                    sender: msg.email,
                    text: msg.message,
                    at: Number(msg.created_at || 0) * 1000
                };
            });
            const last = sourceMessages[sourceMessages.length - 1];
            const members = (messengerThreads.filter(function(t) { return !t.isGroup; }).length) + 1;
            return {
                id: MESSENGER_GROUP_THREAD_ID,
                email: '',
                name: 'Gruppchatt (Alla)',
                avatar: 'https://api.dicebear.com/9.x/initials/svg?seed=Gruppchatt',
                online: true,
                unread: getGroupUnreadCount(),
                pinned: true,
                isGroup: true,
                statusText: members + ' medlemmar',
                updatedAt: last ? Number(last.at) : (existingGroup ? existingGroup.updatedAt : 0),
                lastPreview: last
                    ? ((last.from === 'me' ? 'Du: ' : '') + String(last.text || ''))
                    : 'Inga meddelanden √§n.',
                messages: sourceMessages
            };
        }

        async function loadMessengerUsers() {
            return singleFlightLoad('messengerUsers', async function() {
                const data = await apiGet('/api/messenger/threads');
                const prevGroup = getThreadById(MESSENGER_GROUP_THREAD_ID);
                const prevById = {};
                messengerThreads.forEach(function(thread) {
                    prevById[String(thread.id)] = thread;
                });

                const apiThreads = (data.threads || []).map(function(threadData) {
                    const id = String(threadData.id);
                    const prev = prevById[id];
                    const isGroup = threadData.kind === 'group';
                    const email = String(threadData.email || '');
                    const displayName = isGroup ? String(threadData.name || 'Grupp') : messengerDisplayName(email);
                    const statusText = isGroup
                        ? `${Number(threadData.member_count || 0)} medlemmar`
                        : (threadData.online ? 'Aktiv nu' : 'Offline');
                    const parsedLast = parseReplyPayload(threadData.last_message_text || '');
                    const cleanLastText = String(parsedLast.body || '');
                    return {
                        id: id,
                        kind: String(threadData.kind || 'direct'),
                        email: email,
                        name: displayName,
                        avatar: isGroup
                            ? ('https://api.dicebear.com/9.x/initials/svg?seed=' + encodeURIComponent(displayName))
                            : messengerAvatarUrl(email),
                        online: !!threadData.online,
                        unread: Number(threadData.unread_count || 0),
                        isGroup: isGroup,
                        statusText: statusText,
                        updatedAt: threadData.last_message_at ? Number(threadData.last_message_at) * 1000 : (prev ? prev.updatedAt : 0),
                        lastPreview: cleanLastText
                            ? ((threadData.last_message_from_me ? 'Du: ' : '') + cleanLastText)
                            : 'Inga meddelanden √§n.',
                        messages: prev ? prev.messages : []
                    };
                });

                messengerThreads = [buildPinnedGroupThread(prevGroup)].concat(apiThreads);
                if (!messengerState.activeThreadId && !composeState.active) {
                    messengerState.activeThreadId = MESSENGER_GROUP_THREAD_ID;
                }

                if (messengerState.activeThreadId && !getThreadById(messengerState.activeThreadId)) {
                    messengerState.activeThreadId = null;
                    renderMainChatThreadList();
                    return;
                }

                renderMessengerList();
                const threadView = document.getElementById('msgpThreadView');
                if (threadView && threadView.style.display === 'flex' && messengerState.activeThreadId) {
                    loadActiveMessengerThreadMessages().catch(function() {});
                }
            });
        }

        async function loadActiveMessengerThreadMessages() {
            const loadSeq = ++threadLoadSeq;
            const activeThreadId = messengerState.activeThreadId;
            const thread = getThreadById(activeThreadId);
            if (!thread) return;
            if (thread.id === MESSENGER_GROUP_THREAD_ID) {
                thread.messages = (allChatMessages || []).map(function(msg) {
                    const isMine = msg.email === currentUserEmail;
                    return {
                        from: isMine ? 'me' : 'them',
                        sender: msg.email,
                        text: msg.message,
                        at: Number(msg.created_at || 0) * 1000
                    };
                });
                thread.unread = 0;
                if (thread.messages.length > 0) {
                    const last = thread.messages[thread.messages.length - 1];
                    thread.updatedAt = Number(last.at || thread.updatedAt || Date.now());
                    thread.lastPreview = (last.from === 'me' ? 'Du: ' : '') + String(last.text || '');
                } else {
                    thread.lastPreview = 'Inga meddelanden √§n.';
                }
                markGroupChatRead();
                thread.unread = 0;
                if (loadSeq !== threadLoadSeq || messengerState.activeThreadId !== activeThreadId) return;
                updateMessengerUnreadBadge();
                renderMainChatThreadList();
                renderActiveThreadInMainChat();
                return;
            }
            if (thread.isGroup) {
                const groupData = await apiGet(`/api/messenger/groups/${thread.id}/messages`);
                if (loadSeq !== threadLoadSeq || messengerState.activeThreadId !== activeThreadId) return;
                thread.messages = (groupData.messages || []).map(function(message) {
                    return {
                        from: message.from_me ? 'me' : 'them',
                        sender: message.sender_email || '',
                        text: message.text,
                        at: Number(message.created_at || 0) * 1000
                    };
                });
                thread.unread = 0;
                if (thread.messages.length > 0) {
                    const last = thread.messages[thread.messages.length - 1];
                    thread.updatedAt = Number(last.at || thread.updatedAt || Date.now());
                    thread.lastPreview = (last.from === 'me' ? 'Du: ' : '') + String(last.text || '');
                } else {
                    thread.lastPreview = 'Inga meddelanden √§n.';
                }
                updateMessengerUnreadBadge();
                renderMainChatThreadList();
                renderActiveThreadInMainChat();
                return;
            }
            const data = await apiGet(`/api/messenger/messages/${thread.id}`);
            if (loadSeq !== threadLoadSeq || messengerState.activeThreadId !== activeThreadId) return;
            thread.messages = (data.messages || []).map(function(message) {
                return {
                    from: message.from_me ? 'me' : 'them',
                    text: message.text,
                    at: Number(message.created_at || 0) * 1000
                };
            });
            thread.unread = 0;
            if (thread.messages.length > 0) {
                const last = thread.messages[thread.messages.length - 1];
                thread.updatedAt = Number(last.at || thread.updatedAt || Date.now());
                thread.lastPreview = (last.from === 'me' ? 'Du: ' : '') + String(last.text || '');
            }
            updateMessengerUnreadBadge();
            renderMainChatThreadList();
            renderActiveThreadInMainChat();
        }

        function getThreadById(id) {
            return messengerThreads.find(function(t) { return t.id === id; });
        }

        function formatMessengerTime(ts) {
            if (!ts) return '';
            const diffMinutes = Math.floor((Date.now() - ts) / 60000);
            if (diffMinutes < 1) return 'now';
            if (diffMinutes < 60) return diffMinutes + 'm';
            if (diffMinutes < 1440) return Math.floor(diffMinutes / 60) + 'h';
            return Math.floor(diffMinutes / 1440) + 'd';
        }

        function escapeHtml(str) {
            return str.replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderMessengerList() {
            const list = document.getElementById('msgpList');
            if (!list) {
                updateMessengerUnreadBadge();
                renderMainChatThreadList();
                return;
            }
            const filter = messengerState.filter.trim().toLowerCase();
            const threads = messengerThreads
                .slice()
                .sort(function(a, b) {
                    if (!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;
                    return b.updatedAt - a.updatedAt;
                })
                .filter(function(thread) {
                    if (!filter) return true;
                    const lastMessage = thread.messages[thread.messages.length - 1];
                    const lastText = lastMessage ? String(lastMessage.text || '').toLowerCase() : '';
                    const previewText = String(thread.lastPreview || lastText || '').toLowerCase();
                    return thread.name.toLowerCase().includes(filter) || previewText.includes(filter);
                });

            if (!threads.length) {
                if (list) {
                    list.innerHTML = '<div class="msgp-empty">Inga konversationer matchar s√∂kningen.</div>';
                }
                updateMessengerUnreadBadge();
                renderMainChatThreadList();
                return;
            }

            const listHtml = threads.map(function(thread) {
                const preview = getThreadPreview(thread);
                const previewClipped = preview.length > 42 ? preview.slice(0, 42) + '...' : preview;
                const activeClass = messengerState.activeThreadId === thread.id ? ' is-active' : '';
                const unread = thread.unread > 0 ? '<span class="msgp-unread">' + thread.unread + '</span>' : '';
                return `
                    <button class="msgp-item${activeClass}" type="button" data-thread-id="${thread.id}">
                        <div class="msgp-avatar"><img src="${thread.avatar}" alt="${escapeHtml(thread.name)}"></div>
                        <div class="msgp-text">
                            <strong>${escapeHtml(thread.name)}</strong>
                            <span>${escapeHtml(previewClipped)}</span>
                        </div>
                        <div class="msgp-meta">
                            <span class="msgp-time">${thread.updatedAt ? formatMessengerTime(thread.updatedAt) : ''}</span>
                            ${unread}
                        </div>
                    </button>
                `;
            }).join('');
            if (list) {
                list.innerHTML = listHtml;
            }
            updateMessengerUnreadBadge();
            renderMainChatThreadList();
        }

        function renderMainChatThreadList() {
            const list = document.getElementById('mainChatThreadList');
            if (!list) return;
            const searchInput = document.getElementById('mainChatThreadSearch');
            const filter = String(searchInput ? searchInput.value : '').trim().toLowerCase();
            const threads = messengerThreads
                .slice()
                .sort(function(a, b) {
                    if (!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;
                    return b.updatedAt - a.updatedAt;
                })
                .filter(function(thread) {
                    if (!filter) return true;
                    const haystack = [
                        String(thread.name || ''),
                        String(thread.email || ''),
                        String(thread.lastPreview || '')
                    ].join(' ').toLowerCase();
                    return haystack.includes(filter);
                });

            if (!threads.length) {
                list.innerHTML = '<div class="chat-thread-empty">Inga chattar √§nnu.</div>';
                return;
            }

            list.innerHTML = threads.map(function(thread) {
                const active = messengerState.activeThreadId === thread.id ? ' active' : '';
                const preview = getThreadPreview(thread);
                const unread = thread.unread > 0
                    ? '<span class="chat-thread-unread">' + (thread.unread > 99 ? '99+' : String(thread.unread)) + '</span>'
                    : '';
                const statusDot = !thread.isGroup && thread.id !== MESSENGER_GROUP_THREAD_ID
                    ? `<span class="chat-thread-status-dot${thread.online ? ' online' : ''}" title="${thread.online ? 'Online' : 'Offline'}"></span>`
                    : '';
                return `
                    <button class="chat-thread-row${active}" type="button" data-main-thread-id="${thread.id}">
                        <div class="chat-thread-avatar">
                            <img src="${thread.avatar}" alt="${escapeHtml(thread.name)}">
                            ${statusDot}
                        </div>
                        <div class="chat-thread-text">
                            <strong>${escapeHtml(thread.name)}</strong>
                            <span>${escapeHtml(preview)}</span>
                        </div>
                        <div class="chat-thread-meta">${unread}</div>
                    </button>
                `;
            }).join('');
        }

        function getThreadPreview(thread) {
            const lastMessage = (thread.messages || [])[thread.messages.length - 1];
            if (lastMessage && Number(lastMessage.at || 0) > 0) {
                return (lastMessage.from === 'me' ? 'Du: ' : '') + String(lastMessage.text || '');
            }
            return String(thread.lastPreview || 'Inga meddelanden √§n.');
        }

        function updateMessengerUnreadBadge() {
            const badge = document.getElementById('messengerUnreadBadge');
            const unreadTotal = messengerThreads.reduce(function(sum, thread) {
                return sum + Number(thread.unread || 0);
            }, 0);
            if (badge) {
                if (unreadTotal <= 0) {
                    badge.style.display = 'none';
                    badge.innerText = '0';
                } else {
                    badge.style.display = 'inline-flex';
                    badge.innerText = unreadTotal > 99 ? '99+' : String(unreadTotal);
                }
            }
            const mainBadge = document.getElementById('mainChatUnreadBadge');
            if (!mainBadge) return;
            if (unreadTotal <= 0) {
                mainBadge.style.display = 'none';
                mainBadge.innerText = '0';
                return;
            }
            mainBadge.style.display = 'inline-flex';
            mainBadge.innerText = unreadTotal > 99 ? '99+' : String(unreadTotal);
        }

        function renderActiveThread() {
            const thread = getThreadById(messengerState.activeThreadId);
            if (!thread) return;
            const msgList = document.getElementById('msgpMessages');
            const nameEl = document.getElementById('msgpThreadName');
            const avatarEl = document.getElementById('msgpThreadAvatar');
            const statusEl = document.getElementById('msgpThreadStatus');
            if (!msgList || !nameEl || !avatarEl || !statusEl) return;
            nameEl.innerText = thread.name;
            avatarEl.src = thread.avatar;
            statusEl.innerText = thread.isGroup
                ? thread.statusText
                : (thread.online ? 'Aktiv nu' : 'Offline');

            if (!thread.messages.length) {
                msgList.innerHTML = '<div class="msgp-empty">Inga meddelanden √§n.</div>';
                return;
            }

            msgList.innerHTML = thread.messages.map(function(message) {
                const sender = thread.isGroup && message.from !== 'me'
                    ? `<div class="msgp-sender">${escapeHtml(messengerDisplayName(message.sender || 'Ok√§nd'))}</div>`
                    : '';
                return `
                    <div class="msgp-bubble ${message.from === 'me' ? 'me' : 'them'}">
                        ${sender}
                        ${escapeHtml(message.text)}
                        <span class="msgp-bubble-time">${formatMessengerTime(message.at)}</span>
                    </div>
                `;
            }).join('');
            msgList.scrollTop = msgList.scrollHeight;
        }

        function openMessengerThread(threadId) {
            const listView = document.getElementById('msgpListView');
            const threadView = document.getElementById('msgpThreadView');
            const input = document.getElementById('msgpMessageInput');
            if (!listView || !threadView || !input) return;
            messengerState.activeThreadId = threadId;
            const thread = getThreadById(threadId);
            if (!thread) return;
            listView.style.display = 'none';
            threadView.style.display = 'flex';
            input.focus();
            loadActiveMessengerThreadMessages().catch(function() {});
        }

        function openMessengerList() {
            const threadView = document.getElementById('msgpThreadView');
            const listView = document.getElementById('msgpListView');
            if (!threadView || !listView) return;
            threadView.style.display = 'none';
            listView.style.display = 'flex';
            renderMessengerList();
        }

        function openThreadFromMainSidebar(threadId) {
            closeComposeMode();
            messengerState.activeThreadId = threadId;
            if (threadId === MESSENGER_GROUP_THREAD_ID) {
                markGroupChatRead();
                const groupThread = getThreadById(threadId);
                if (groupThread) groupThread.unread = 0;
            } else {
                loadActiveMessengerThreadMessages().catch(function() {});
            }
            renderMainChatThreadList();
            document.getElementById('groupChatInput').focus();
            renderActiveThreadInMainChat();
        }

        function openGroupCreateModal() {
            const modal = document.getElementById('groupCreateModal');
            const list = document.getElementById('groupCreateUserList');
            const nameInput = document.getElementById('groupCreateName');
            if (!modal || !list || !nameInput) return;

            const users = messengerThreads.filter(function(t) {
                return !t.isGroup;
            });
            if (!users.length) {
                alert('Det finns inga anv√§ndare att bjuda in.');
                return;
            }

            list.innerHTML = users.map(function(thread) {
                return `
                    <label class="group-create-item">
                        <input type="checkbox" value="${thread.id}">
                        <span>${escapeHtml(thread.name)} (${escapeHtml(thread.email)})</span>
                    </label>
                `;
            }).join('');
            nameInput.value = '';
            modal.style.display = 'flex';
            nameInput.focus();
        }

        function closeGroupCreateModal() {
            const modal = document.getElementById('groupCreateModal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        async function createGroupAndInvite() {
            const nameInput = document.getElementById('groupCreateName');
            const userList = document.getElementById('groupCreateUserList');
            if (!nameInput || !userList) return;

            const name = nameInput.value.trim();
            const selectedIds = Array.from(userList.querySelectorAll('input[type="checkbox"]:checked'))
                .map(function(el) { return String(el.value); });

            if (!name) {
                alert('Ange ett gruppnamn.');
                return;
            }
            if (!selectedIds.length) {
                alert('V√§lj minst en anv√§ndare att bjuda in.');
                return;
            }

            const response = await apiSend('/api/messenger/groups', 'POST', {
                name: name,
                invitee_ids: selectedIds.map(function(id) { return Number(id); })
            });

            closeGroupCreateModal();
            await loadMessengerUsers();
            messengerState.activeThreadId = String(response.group_id || '');
            renderMainChatThreadList();
        }

        async function sendMessengerMessage() {
            const input = document.getElementById('msgpMessageInput');
            if (!input) return;
            const text = input.value.trim();
            const thread = getThreadById(messengerState.activeThreadId);
            if (!thread || !text) return;

            if (thread.id === MESSENGER_GROUP_THREAD_ID) {
                await apiSend('/api/chat/messages', 'POST', { message: text });
                await loadChatMessages();
            } else {
                await apiSend('/api/messenger/messages', 'POST', {
                    recipient_id: Number(thread.id),
                    message: text
                });
            }
            input.value = '';
            await loadActiveMessengerThreadMessages();
            await loadMessengerUsers();
        }

        function initMessenger() {
            loadMessengerUsers().then(function() {
                renderActiveThreadInMainChat();
            }).catch(function() {});

            window.addEventListener('focus', function() {
                loadMessengerUsers().catch(function() {});
            });
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) loadMessengerUsers().catch(function() {});
            });

            const searchInput = document.getElementById('msgpSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    messengerState.filter = e.target.value;
                    renderMessengerList();
                });
            }

            const popupList = document.getElementById('msgpList');
            if (popupList) {
                popupList.addEventListener('click', function(e) {
                    const row = e.target.closest('[data-thread-id]');
                    if (!row) return;
                    openMessengerThread(row.getAttribute('data-thread-id'));
                });
            }

            const backBtn = document.getElementById('msgpBackBtn');
            if (backBtn) {
                backBtn.addEventListener('click', function() {
                    openMessengerList();
                });
            }

            const sendBtn = document.getElementById('msgpSendBtn');
            if (sendBtn) {
                sendBtn.addEventListener('click', function() {
                    sendMessengerMessage().catch(function() {});
                });
            }

            const msgInput = document.getElementById('msgpMessageInput');
            if (msgInput) {
                msgInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') sendMessengerMessage().catch(function() {});
                });
            }

            const mainThreadList = document.getElementById('mainChatThreadList');
            if (mainThreadList) {
                mainThreadList.addEventListener('click', function(e) {
                    const row = e.target.closest('[data-main-thread-id]');
                    if (!row) return;
                    openThreadFromMainSidebar(row.getAttribute('data-main-thread-id'));
                });
            }

            const threadSearch = document.getElementById('mainChatThreadSearch');
            if (threadSearch) {
                threadSearch.addEventListener('input', function() {
                    renderMainChatThreadList();
                });
            }

            const newGroupBtn = document.getElementById('newGroupBtn');
            const newComposeBtn = document.getElementById('newComposeBtn');
            if (newComposeBtn) {
                newComposeBtn.addEventListener('click', function() {
                    openComposeMode();
                });
            }

            const saveGroupBtn = document.getElementById('groupCreateSaveBtn');
            if (saveGroupBtn) {
                saveGroupBtn.addEventListener('click', function() {
                    createGroupAndInvite().catch(function(err) {
                        alert(err.message || 'Kunde inte skapa gruppen.');
                    });
                });
            }

            const groupModal = document.getElementById('groupCreateModal');
            if (groupModal) {
                groupModal.addEventListener('click', function(e) {
                    if (e.target === groupModal) closeGroupCreateModal();
                });
            }

            const replyCancelBtn = document.getElementById('chatReplyCancelBtn');
            if (replyCancelBtn) {
                replyCancelBtn.addEventListener('click', function() {
                    setActiveReply(null);
                });
            }
        }

        // JS f√∂r Messenger popup
        function toggleMessenger() {
            const popup = document.getElementById('msgPopup');
            if (!popup) return;
            if(popup.style.display === 'flex') {
                popup.style.display = 'none';
            } else {
                popup.style.display = 'flex';
                openMessengerList();
            }
        }

        async function handleGroupInviteFromUrl() {
            const pathMatch = window.location.pathname.match(/^\/group-invite\/([^/]+)$/);
            if (!pathMatch) return;
            const groupId = decodeURIComponent(pathMatch[1]);
            const token = new URLSearchParams(window.location.search).get('token') || '';
            if (!groupId || !token) {
                history.replaceState({}, '', '/');
                return;
            }
            try {
                await apiSend('/api/messenger/invites/accept', 'POST', {
                    group_id: groupId,
                    token: token
                });
                history.replaceState({}, '', '/');
                await loadMessengerUsers();
                messengerState.activeThreadId = groupId;
                renderMainChatThreadList();
                alert('Inbjudan accepterad. Du har g√•tt med i gruppen.');
            } catch (err) {
                history.replaceState({}, '', '/');
                alert(err.message || 'Kunde inte acceptera inbjudan.');
            }
        }

        document.getElementById('modalEditEventBtn').addEventListener('click', function() {
            if (!activeModalEvent || !currentUserIsAdmin) return;
            openEventEditorEdit(activeModalEvent);
        });
        document.getElementById('eventEditorSaveBtn').addEventListener('click', function() {
            saveEventFromEditor().catch(function(err) {
                alert(err.message || 'Kunde inte spara m√∂tet.');
            });
        });
        document.getElementById('eventEditorModal').addEventListener('click', function(e) {
            if (e.target === this) closeEventEditor();
        });

        document.getElementById('prevMonthBtn').addEventListener('click', function() {
            changeMonth(-1).catch(function() {});
        });
        document.getElementById('nextMonthBtn').addEventListener('click', function() {
            changeMonth(1).catch(function() {});
        });
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshPollingSoon();
                refreshFsAutoRefreshSoon();
            }
        });
        window.addEventListener('focus', function() {
            refreshPollingSoon();
            refreshFsAutoRefreshSoon();
        });

        (async function initApp() {
            document.body.style.visibility = 'hidden';
            const allowed = await requireAuth();
            if (!allowed) return;
            await handleGroupInviteFromUrl();
            initGroupChat();
            initNotes();
            await Promise.allSettled([
                loadMonthEvents(),
                loadTodayMeetings(),
                loadChatMessages(),
                loadChatPresence(),
                loadNotes(),
                fsLoadState(true)
            ]);
            renderCalendar();
            initMessenger();
            startAdaptivePolling();
            startFsAutoRefresh();
            document.body.style.visibility = 'visible';
        })();
    </script>
</body>
</html>
