<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chatt Widget Demo</title>
    <style>
        /* === BASE STYLES === */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: #f8f9fa; height: 100vh; overflow: hidden; }

        /* === LAUNCHER BUTTON === */
        #widget-launcher {
            position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px;
            background-color: #0084ff; border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease; z-index: 1000;
        }
        #widget-launcher:hover { transform: scale(1.05); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
        #widget-launcher svg { fill: #fff; width: 32px; height: 32px; }

        /* === MAIN WIDGET CONTAINER === */
        #chat-widget {
            position: fixed; bottom: 100px; right: 24px; width: 380px; height: 600px; max-height: calc(100vh - 120px);
            background: #fff; border-radius: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; overflow: hidden; z-index: 999;
            opacity: 0; pointer-events: none; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        #chat-widget.open { opacity: 1; pointer-events: auto; transform: translateY(0); }

        /* Mobile responsiveness */
        @media (max-width: 450px) {
            #chat-widget { bottom: 0; right: 0; width: 100%; height: 100%; max-height: 100vh; border-radius: 0; }
            #widget-launcher { bottom: 16px; right: 16px; }
        }

        /* === HEADER & SEARCH === */
        .header { background: #fff; padding: 12px 16px; border-bottom: 1px solid #e4e6eb; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
        .header h2 { font-size: 1.2rem; color: #050505; }
        .icon-btn { background: none; border: none; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; justify-content: center; align-items: center; transition: background 0.2s; }
        .icon-btn:hover { background: #f0f2f5; }
        .icon-btn svg { fill: #0084ff; width: 20px; height: 20px; }
        
        .search-bar { padding: 8px 16px; background: #fff; flex-shrink: 0; position: relative; }
        .search-bar input { width: 100%; background: #f0f2f5; border: none; border-radius: 20px; padding: 10px 16px 10px 36px; outline: none; font-size: 0.95rem; }
        .search-bar svg { position: absolute; left: 28px; top: 18px; fill: #65676b; width: 16px; height: 16px; }

        /* === VIEW MANAGER === */
        .view-container { flex: 1; position: relative; overflow: hidden; background: #fff; }
        .view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        
        .view.slide-left { transform: translateX(-100%); }
        .view.slide-right { transform: translateX(100%); }
        .view.active { transform: translateX(0); z-index: 10; }

        /* Custom Scrollbar */
        .scrollable { overflow-y: auto; flex: 1; }
        .scrollable::-webkit-scrollbar { width: 6px; }
        .scrollable::-webkit-scrollbar-thumb { background: #bcc0c4; border-radius: 10px; }

        /* === LIST ITEMS (Convos & Contacts) === */
        .list-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; transition: background 0.2s; }
        .list-item:hover { background: #f0f2f5; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: #e4e6eb; margin-right: 12px; position: relative; flex-shrink: 0; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#050505; }
        .avatar img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
        .online-dot { position: absolute; bottom: 0; right: 0; width: 14px; height: 14px; background: #31a24c; border: 2px solid #fff; border-radius: 50%; }
        .item-info { flex: 1; overflow: hidden; }
        .item-top { display: flex; justify-content: space-between; align-items: baseline; }
        .item-name { font-weight: 600; color: #050505; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-time { font-size: 0.75rem; color: #65676b; }
        .item-preview { font-size: 0.85rem; color: #65676b; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }
        .unread .item-name, .unread .item-preview { color: #050505; font-weight: 600; }

        /* === CHAT VIEW === */
        .chat-header { background: #fff; padding: 12px; border-bottom: 1px solid #e4e6eb; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 2; }
        .chat-header .avatar { width: 36px; height: 36px; margin: 0 10px; }
        .chat-feed { padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        
        .message { display: flex; max-width: 75%; flex-direction: column; }
        .msg-mine { align-self: flex-end; align-items: flex-end; }
        .msg-theirs { align-self: flex-start; align-items: flex-start; }
        
        .msg-bubble { padding: 10px 14px; border-radius: 18px; font-size: 0.95rem; line-height: 1.4; word-wrap: break-word; }
        .msg-mine .msg-bubble { background: #0084ff; color: #fff; border-bottom-right-radius: 4px; }
        .msg-theirs .msg-bubble { background: #e4e6eb; color: #050505; border-bottom-left-radius: 4px; }
        
        .msg-sender { font-size: 0.7rem; color: #65676b; margin-bottom: 4px; margin-left: 4px; }
        .msg-time { font-size: 0.7rem; color: #65676b; margin-top: 4px; opacity: 0.8; }
        .msg-mine .msg-time { text-align: right; }

        /* === CHAT INPUT === */
        .chat-input-area { padding: 12px; background: #fff; border-top: 1px solid #e4e6eb; display: flex; align-items: flex-end; gap: 8px; }
        .input-wrapper { flex: 1; background: #f0f2f5; border-radius: 20px; display: flex; align-items: center; padding: 8px 12px; }
        .input-wrapper textarea { flex: 1; border: none; background: transparent; outline: none; resize: none; max-height: 80px; font-size: 0.95rem; padding: 0; margin-right: 8px; }
        
        /* === ACTION BUTTONS === */
        .action-btn-large { margin: 16px; padding: 12px; background: #e7f3ff; color: #0084ff; text-align: center; border-radius: 8px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        .action-btn-large:hover { background: #dbedff; }
        
        .file-attachment { background: #f0f2f5; border-radius: 8px; padding: 8px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; color: #050505; }
        .file-attachment svg { width: 16px; fill: #65676b; }
    </style>
</head>
<body>

    <!-- Launcher -->
    <div id="widget-launcher" onclick="toggleWidget()">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.477 2 2 6.145 2 11.259c0 2.913 1.474 5.503 3.765 7.184V22l3.435-1.897c.884.246 1.815.38 2.8.38 5.523 0 10-4.145 10-9.224S17.523 2 12 2zm1.096 12.353l-2.846-3.033-5.548 3.033 6.09-6.463 2.898 3.032 5.496-3.032-6.09 6.463z"/></svg>
    </div>

    <!-- Chat Widget -->
    <div id="chat-widget">
        <!-- Main Header -->
        <div id="main-header">
            <div class="header">
                <h2>Meddelanden</h2>
                <button class="icon-btn" onclick="toggleWidget()"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <div class="search-bar">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                <input type="text" id="searchInput" placeholder="S√∂k eller starta ny chatt..." onfocus="openSearch()" onkeyup="handleSearch()">
            </div>
        </div>

        <!-- Views Container -->
        <div class="view-container">
            
            <!-- View 1: Conversations List -->
            <div id="view-convos" class="view active scrollable">
                <div id="convo-list"></div>
            </div>

            <!-- View 2: Search / Contacts List -->
            <div id="view-search" class="view slide-right scrollable">
                <div class="action-btn-large" onclick="createGroup()">+ Skapa ny grupp</div>
                <div style="padding: 0 16px 8px; font-weight: 600; color: #65676b; font-size: 0.85rem;">Kontakter</div>
                <div id="contact-list"></div>
            </div>

            <!-- View 3: Active Chat -->
            <div id="view-chat" class="view slide-right">
                <div class="chat-header">
                    <button class="icon-btn" onclick="backToMain()"><svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg></button>
                    <div id="active-chat-avatar" class="avatar"></div>
                    <div class="item-info" style="margin-left:8px;">
                        <div id="active-chat-name" class="item-name">Namn</div>
                        <div id="active-chat-status" class="item-time">Aktiv nu</div>
                    </div>
                </div>
                
                <div class="chat-feed scrollable" id="chat-feed">
                    <!-- Messages go here -->
                </div>

                <div class="chat-input-area">
                    <input type="file" id="fileInput" style="display:none" onchange="handleFileUpload(event)">
                    <button class="icon-btn" onclick="document.getElementById('fileInput').click()"><svg viewBox="0 0 24 24"><path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5a2.5 2.5 0 0 1 5 0v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5a2.5 2.5 0 0 0 5 0V5c0-1.38-1.12-2.5-2.5-2.5S8 3.62 8 5v11.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/></svg></button>
                    
                    <div class="input-wrapper">
                        <textarea id="messageInput" rows="1" placeholder="Skriv ett meddelande..." oninput="autoGrow(this)" onkeydown="checkEnter(event)"></textarea>
                        <button class="icon-btn" style="padding:4px;" onclick="addEmoji()"><svg viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg></button>
                    </div>
                    
                    <button class="icon-btn" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // === MOCK DATABASE ===
        const me = { id: 'u0', name: 'Du' };
        
        let users = [
            { id: 'u1', name: 'Anna Andersson', initials: 'AA', color: '#ff7f50', online: true },
            { id: 'u2', name: 'Erik Svensson', initials: 'ES', color: '#6495ed', online: false },
            { id: 'u3', name: 'Johanna Lind', initials: 'JL', color: '#da70d6', online: true },
            { id: 'u4', name: 'Mikael Berg', initials: 'MB', color: '#20b2aa', online: true }
        ];

        let conversations = [
            {
                id: 'c1', isGroup: false, participants: ['u1'], 
                messages: [
                    { sender: 'u1', text: 'Hej! Hur g√•r det med projektet?', time: '09:12' },
                    { sender: me.id, text: 'Det rullar p√• bra! Skickar en uppdatering snart.', time: '09:15' }
                ]
            },
            {
                id: 'c2', isGroup: true, name: 'Utvecklingsteamet', participants: ['u1', 'u2', 'u3'], 
                messages: [
                    { sender: 'u2', text: 'Gl√∂m inte m√∂tet kl 14.', time: 'Ig√•r' }
                ]
            }
        ];

        let activeConvoId = null;

        // === INITIALIZATION ===
        function init() {
            renderConversations();
            renderContacts(users);
        }

        // === UI LOGIC & NAVIGATION ===
        const widget = document.getElementById('chat-widget');
        const viewConvos = document.getElementById('view-convos');
        const viewSearch = document.getElementById('view-search');
        const viewChat = document.getElementById('view-chat');
        const searchInput = document.getElementById('searchInput');

        function toggleWidget() {
            widget.classList.toggle('open');
            if(widget.classList.contains('open') && activeConvoId == null) {
                searchInput.focus();
            }
        }

        function openSearch() {
            if(activeConvoId) return; // Don't search if in chat
            viewConvos.classList.add('slide-left');
            viewConvos.classList.remove('active');
            viewSearch.classList.add('active');
            viewSearch.classList.remove('slide-right');
            renderContacts(users); // Show all by default
        }

        function cancelSearch() {
            searchInput.value = '';
            viewSearch.classList.remove('active');
            viewSearch.classList.add('slide-right');
            viewConvos.classList.add('active');
            viewConvos.classList.remove('slide-left');
            renderConversations();
        }

        function openChat(convoId) {
            activeConvoId = convoId;
            searchInput.value = '';
            document.getElementById('main-header').style.display = 'none'; // Hide main header
            
            // Slide animations
            viewConvos.classList.add('slide-left');
            viewSearch.classList.add('slide-left');
            viewChat.classList.add('active');
            viewChat.classList.remove('slide-right');

            renderChatFeed();
        }

        function backToMain() {
            activeConvoId = null;
            document.getElementById('main-header').style.display = 'block';
            searchInput.value = '';
            
            viewChat.classList.remove('active');
            viewChat.classList.add('slide-right');
            viewConvos.classList.remove('slide-left');
            viewConvos.classList.add('active');
            viewSearch.classList.remove('active');
            viewSearch.classList.add('slide-right');
            
            renderConversations();
        }

        // === RENDERING LOGIC ===
        function getAvatarHtml(user) {
            if(!user) return `<div class="avatar" style="background:#ddd">G</div>`;
            return `<div class="avatar" style="background:${user.color}33; color:${user.color}">${user.initials}${user.online ? '<div class="online-dot"></div>' : ''}</div>`;
        }

        function renderConversations() {
            const list = document.getElementById('convo-list');
            list.innerHTML = '';
            
            if(conversations.length === 0) {
                list.innerHTML = `<div style="padding:20px; text-align:center; color:#65676b;">Inga meddelanden √§n.</div>`;
                return;
            }

            // Sort by latest message (simulated by array order for demo)
            [...conversations].reverse().forEach(c => {
                const lastMsg = c.messages[c.messages.length - 1];
                let title = c.isGroup ? c.name : users.find(u => u.id === c.participants[0]).name;
                let avatar = c.isGroup ? `<div class="avatar" style="background:#e4e6eb">üë•</div>` : getAvatarHtml(users.find(u => u.id === c.participants[0]));
                let prefix = lastMsg.sender === me.id ? 'Du: ' : '';

                list.innerHTML += `
                    <div class="list-item" onclick="openChat('${c.id}')">
                        ${avatar}
                        <div class="item-info">
                            <div class="item-top">
                                <div class="item-name">${title}</div>
                                <div class="item-time">${lastMsg.time}</div>
                            </div>
                            <div class="item-preview">${prefix}${lastMsg.text}</div>
                        </div>
                    </div>
                `;
            });
        }

        function renderContacts(filteredUsers) {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            filteredUsers.forEach(u => {
                list.innerHTML += `
                    <div class="list-item" onclick="startDirectChat('${u.id}')">
                        ${getAvatarHtml(u)}
                        <div class="item-info">
                            <div class="item-name">${u.name}</div>
                        </div>
                    </div>
                `;
            });
        }

        function renderChatFeed() {
            const convo = conversations.find(c => c.id === activeConvoId);
            const feed = document.getElementById('chat-feed');
            
            // Header
            let title = convo.isGroup ? convo.name : users.find(u => u.id === convo.participants[0]).name;
            let avatar = convo.isGroup ? `<div class="avatar" style="background:#e4e6eb">üë•</div>` : getAvatarHtml(users.find(u => u.id === convo.participants[0]));
            let status = convo.isGroup ? `${convo.participants.length} medlemmar` : (users.find(u => u.id === convo.participants[0]).online ? 'Aktiv nu' : 'Offline');

            document.getElementById('active-chat-name').innerText = title;
            document.getElementById('active-chat-status').innerText = status;
            document.getElementById('active-chat-avatar').outerHTML = `<div id="active-chat-avatar">${avatar}</div>`;

            // Messages
            feed.innerHTML = '';
            convo.messages.forEach(m => {
                const isMe = m.sender === me.id;
                const senderName = isMe ? '' : (convo.isGroup ? users.find(u=>u.id===m.sender)?.name || 'Ok√§nd' : '');
                
                feed.innerHTML += `
                    <div class="message ${isMe ? 'msg-mine' : 'msg-theirs'}">
                        ${senderName ? `<div class="msg-sender">${senderName}</div>` : ''}
                        <div class="msg-bubble">${m.text}</div>
                        <div class="msg-time">${m.time}</div>
                    </div>
                `;
            });
            scrollToBottom();
        }

        // === ACTIONS ===
        function handleSearch() {
            const val = searchInput.value.toLowerCase();
            if(!val && viewSearch.classList.contains('active')) {
                renderContacts(users);
                return;
            }
            if(val && !viewSearch.classList.contains('active')) openSearch();
            
            const filtered = users.filter(u => u.name.toLowerCase().includes(val));
            renderContacts(filtered);
        }

        function startDirectChat(userId) {
            let convo = conversations.find(c => !c.isGroup && c.participants[0] === userId);
            if(!convo) {
                convo = { id: 'c' + Date.now(), isGroup: false, participants: [userId], messages: [] };
                conversations.push(convo);
            }
            openChat(convo.id);
        }

        function createGroup() {
            const name = prompt("Ange namn p√• gruppen:");
            if(!name) return;
            // Add all users to demo group
            const convo = { 
                id: 'c' + Date.now(), 
                isGroup: true, 
                name: name, 
                participants: users.map(u => u.id), 
                messages: [{ sender: me.id, text: 'Skapade gruppen', time: getCurrentTime() }] 
            };
            conversations.push(convo);
            openChat(convo.id);
        }

        function sendMessage(textParam = null) {
            const input = document.getElementById('messageInput');
            const text = textParam || input.value.trim();
            if(!text || !activeConvoId) return;

            const convo = conversations.find(c => c.id === activeConvoId);
            convo.messages.push({ sender: me.id, text: text, time: getCurrentTime() });
            
            input.value = '';
            input.style.height = 'auto'; // reset height
            renderChatFeed();

            // Simulate reply
            if(!convo.isGroup || Math.random() > 0.5) {
                const replierId = convo.isGroup ? convo.participants[Math.floor(Math.random() * convo.participants.length)] : convo.participants[0];
                setTimeout(() => {
                    convo.messages.push({ sender: replierId, text: 'Visst, jag f√∂rst√•r! üëç', time: getCurrentTime() });
                    if(activeConvoId === convo.id) renderChatFeed();
                }, 1500 + Math.random() * 1000);
            }
        }

        function addEmoji() {
            const emojis = ['üòÇ','‚ù§Ô∏è','üëç','üî•','üòä','üéâ'];
            const e = emojis[Math.floor(Math.random() * emojis.length)];
            const input = document.getElementById('messageInput');
            input.value += e;
            input.focus();
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if(file) {
                const html = `<div class="file-attachment"><svg viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg> ${file.name}</div>`;
                sendMessage(html);
            }
        }

        // === UTILS ===
        function getCurrentTime() {
            const d = new Date();
            return d.getHours().toString().padStart(2, '0') + ':' + d.getMinutes().toString().padStart(2, '0');
        }

        function scrollToBottom() {
            const feed = document.getElementById('chat-feed');
            feed.scrollTop = feed.scrollHeight;
        }

        function autoGrow(element) {
            element.style.height = "5px";
            element.style.height = (element.scrollHeight) + "px";
        }

        function checkEnter(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        // Detect click outside search to close it if empty
        document.addEventListener('click', (e) => {
            const header = document.getElementById('main-header');
            if(header && !header.contains(e.target) && searchInput.value === '' && viewSearch.classList.contains('active')) {
                cancelSearch();
            }
        });

        // Run init
        init();
    </script>
</body>
</html>